<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32-WiFiScreen</title>
<style>
    .no-select{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
    
:root{--fore-color:#111;--secondary-fore-color:#444;--back-color:#f8f8f8;--secondary-back-color:#f0f0f0;--blockquote-color:#f57c00;--pre-color:#1565c0;--border-color:#aaa;--secondary-border-color:#ddd;--heading-ratio:1.19;--universal-margin:.5rem;--universal-padding:.5rem;--universal-border-radius:.125rem;--a-link-color:#0277bd;--a-visited-color:#01579b}html{font-size:16px}span{font-size:1em}html,*{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Helvetica, sans-serif;line-height:1.5;-webkit-text-size-adjust:100%}*{font-size:1rem}body{margin:0;color:var(--fore-color);background:var(--back-color)}input{overflow:visible}h4{line-height:1.2;margin:calc(1.5 * var(--universal-margin)) var(--universal-margin);font-weight:500}h4{font-size:calc(1rem * var(--heading-ratio))}p{margin:var(--universal-margin)}ul{margin:var(--universal-margin);padding-left:calc(2 * var(--universal-margin))}.row{box-sizing:border-box;display:flex;flex:0 1 auto;flex-flow:row wrap}[class^='col-sm-']{box-sizing:border-box;flex:0 0 auto;padding:0 calc(var(--universal-padding) / 2)}.col-sm-12{max-width:100%;flex-basis:100%}@media screen and (min-width: 768px){.col-md{box-sizing:border-box;flex:0 0 auto;padding:0 calc(var(--universal-padding) / 2)}.col-md{max-width:100%;flex-grow:1;flex-basis:0}.col-md-3{max-width:25%;flex-basis:25%}}:root{--card-back-color:#f8f8f8;--card-fore-color:#111;--card-border-color:#ddd}.card{display:flex;flex-direction:column;justify-content:space-between;align-self:center;position:relative;width:100%;background:var(--card-back-color);color:var(--card-fore-color);border:.0625rem solid var(--card-border-color);border-radius:var(--universal-border-radius);margin:var(--universal-margin);overflow:hidden}@media screen and (min-width: 320px){.card{max-width:320px}}.card>.section{background:var(--card-back-color);color:var(--card-fore-color);box-sizing:border-box;margin:0;border:0;border-radius:0;border-bottom:.0625rem solid var(--card-border-color);padding:var(--universal-padding);width:100%}.card>.section:last-child{border-bottom:0}:root{--form-back-color:#f0f0f0;--form-fore-color:#111;--form-border-color:#ddd;--input-back-color:#f8f8f8;--input-fore-color:#111;--input-border-color:#ddd;--input-focus-color:#0288d1;--input-invalid-color:#d32f2f;--button-back-color:#e2e2e2;--button-hover-back-color:#dcdcdc;--button-fore-color:#212121;--button-border-color:rgba(0,0,0,0);--button-hover-border-color:rgba(0,0,0,0);--button-group-border-color:rgba(124,124,124,0.54)}form{background:var(--form-back-color);color:var(--form-fore-color);border:.0625rem solid var(--form-border-color);border-radius:var(--universal-border-radius);margin:var(--universal-margin);padding:calc(2 * var(--universal-padding)) var(--universal-padding)}fieldset{border:.0625rem solid var(--form-border-color);border-radius:var(--universal-border-radius);margin:calc(var(--universal-margin) / 4);padding:var(--universal-padding)}legend{box-sizing:border-box;display:table;max-width:100%;white-space:normal;font-weight:700;padding:calc(var(--universal-padding) / 2)}label{padding:calc(var(--universal-padding) / 2) var(--universal-padding)}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}input:not([type]),[type="text"],[type="number"],[type="checkbox"],select{box-sizing:border-box;background:var(--input-back-color);color:var(--input-fore-color);border:.0625rem solid var(--input-border-color);border-radius:var(--universal-border-radius);margin:calc(var(--universal-margin) / 2);padding:var(--universal-padding) calc(1.5 * var(--universal-padding))}input:not([type="button"]):not([type="submit"]):not([type="reset"]):hover,input:not([type="button"]):not([type="submit"]):not([type="reset"]):focus,select:hover,select:focus{border-color:var(--input-focus-color);box-shadow:none}input:not([type="button"]):not([type="submit"]):not([type="reset"]):invalid,input:not([type="button"]):not([type="submit"]):not([type="reset"]):focus:invalid,select:invalid,select:focus:invalid{border-color:var(--input-invalid-color);box-shadow:none}select{max-width:100%}option{overflow:hidden;text-overflow:ellipsis}[type="checkbox"]{-webkit-appearance:none;-moz-appearance:none;appearance:none;position:relative;height:calc(1rem + var(--universal-padding) / 2);width:calc(1rem + var(--universal-padding) / 2);vertical-align:text-bottom;padding:0;flex-basis:calc(1rem + var(--universal-padding) / 2) !important;flex-grow:0 !important}[type="checkbox"]:checked:before{position:absolute}[type="checkbox"]:checked:before{content:'\2713';font-family:sans-serif;font-size:calc(1rem + var(--universal-padding) / 2);top:calc(0rem - var(--universal-padding));left:calc(var(--universal-padding) / 4)}:placeholder-shown{color:var(--input-fore-color)}::-ms-placeholder{color:var(--input-fore-color);opacity:0.54}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button,html [type="button"],[type="submit"]{-webkit-appearance:button}button{overflow:visible;text-transform:none}button,[type="button"],[type="submit"],label.button,.button{display:inline-block;background:var(--button-back-color);color:var(--button-fore-color);border:.0625rem solid var(--button-border-color);border-radius:var(--universal-border-radius);padding:var(--universal-padding) calc(1.5 * var(--universal-padding));margin:var(--universal-margin);text-decoration:none;cursor:pointer;transition:background 0.3s}button:hover,button:focus,[type="button"]:hover,[type="button"]:focus,[type="submit"]:hover,[type="submit"]:focus,label.button:hover,label.button:focus,.button:hover,.button:focus{background:var(--button-hover-back-color);border-color:var(--button-hover-border-color)}input:disabled,select:disabled,button:disabled,.button:disabled{cursor:not-allowed;opacity:.75}.button-group{display:flex;border:.0625rem solid var(--button-group-border-color);border-radius:var(--universal-border-radius);margin:var(--universal-margin)}.button-group>button,.button-group [type="button"],.button-group>[type="submit"]{margin:0;max-width:100%;flex:1 1 auto;text-align:center;border:0;border-radius:0;box-shadow:none}.button-group>:not(:first-child){border-left:.0625rem solid var(--button-group-border-color)}@media screen and (max-width: 767px){.button-group{flex-direction:column}.button-group>:not(:first-child){border:0;border-top:.0625rem solid var(--button-group-border-color)}}button.primary,[type="submit"].primary{--button-back-color:#1976d2;--button-fore-color:#f8f8f8}button.primary:hover,button.primary:focus,[type="submit"].primary:hover,[type="submit"].primary:focus{--button-hover-back-color:#1565c0}button.tertiary,[type="button"].tertiary,.button.tertiary{--button-back-color:#308732;--button-fore-color:#f8f8f8}button.tertiary:hover,button.tertiary:focus,[type="button"].tertiary:hover,[type="button"].tertiary:focus,.button.tertiary:hover,.button.tertiary:focus{--button-hover-back-color:#277529}:root{--header-back-color:#f8f8f8;--header-hover-back-color:#f0f0f0;--header-fore-color:#444;--header-border-color:#ddd;--nav-back-color:#f8f8f8;--nav-hover-back-color:#f0f0f0;--nav-fore-color:#444;--nav-border-color:#ddd;--nav-link-color:#0277bd;--footer-fore-color:#444;--footer-back-color:#f8f8f8;--footer-border-color:#ddd;--footer-link-color:#0277bd;--drawer-back-color:#f8f8f8;--drawer-hover-back-color:#f0f0f0;--drawer-border-color:#ddd;--drawer-close-color:#444}.drawer-toggle:before{display:inline-block;position:relative;vertical-align:bottom;content:'\00a0\2261\00a0';font-family:sans-serif;font-size:1.5em}[type="checkbox"].drawer{height:1px;width:1px;margin:-1px;overflow:hidden;position:absolute;clip:rect(0 0 0 0);-webkit-clip-path:inset(100%);clip-path:inset(100%)}[type="checkbox"].drawer+*{display:block;box-sizing:border-box;position:fixed;top:0;width:320px;height:100vh;overflow-y:auto;background:var(--drawer-back-color);border:.0625rem solid var(--drawer-border-color);border-radius:0;margin:0;z-index:1110;right:-320px;transition:right 0.3s}[type="checkbox"].drawer+* .drawer-close{position:absolute;top:var(--universal-margin);right:var(--universal-margin);z-index:1111;width:2rem;height:2rem;border-radius:var(--universal-border-radius);padding:var(--universal-padding);margin:0;cursor:pointer;transition:background 0.3s}[type="checkbox"].drawer+* .drawer-close:before{display:block;content:'\00D7';color:var(--drawer-close-color);position:relative;font-family:sans-serif;font-size:2rem;line-height:1;text-align:center}[type="checkbox"].drawer+* .drawer-close:hover,[type="checkbox"].drawer+* .drawer-close:focus{background:var(--drawer-hover-back-color)}@media screen and (max-width: 320px){[type="checkbox"].drawer+*{width:100%}}[type="checkbox"].drawer:checked+*{right:0}:root{--table-border-color:#aaa;--table-border-separator-color:#666;--table-head-back-color:#e6e6e6;--table-head-fore-color:#111;--table-body-back-color:#f8f8f8;--table-body-fore-color:#111;--table-body-alt-back-color:#eee}:root{--table-body-alt-back-color:#eee}:root{--table-body-hover-back-color:#90caf9}:root{--mark-back-color:#0277bd;--mark-fore-color:#fafafa}:root{--toast-back-color:#424242;--toast-fore-color:#fafafa}:root{--tooltip-back-color:#212121;--tooltip-fore-color:#fafafa}:root{--modal-overlay-color:rgba(0,0,0,0.45);--modal-close-color:#444;--modal-close-hover-color:#f0f0f0}[type="checkbox"].modal{height:1px;width:1px;margin:-1px;overflow:hidden;position:absolute;clip:rect(0 0 0 0);-webkit-clip-path:inset(100%);clip-path:inset(100%)}[type="checkbox"].modal+div{position:fixed;top:0;left:0;display:none;width:100vw;height:100vh;background:var(--modal-overlay-color)}[type="checkbox"].modal+div .card{margin:0 auto;max-height:50vh;overflow:auto}[type="checkbox"].modal+div .card .modal-close{position:absolute;top:0;right:0;width:1.75rem;height:1.75rem;border-radius:var(--universal-border-radius);padding:var(--universal-padding);margin:0;cursor:pointer;transition:background 0.3s}[type="checkbox"].modal+div .card .modal-close:before{display:block;content:'\00D7';color:var(--modal-close-color);position:relative;font-family:sans-serif;font-size:1.75rem;line-height:1;text-align:center}[type="checkbox"].modal+div .card .modal-close:hover,[type="checkbox"].modal+div .card .modal-close:focus{background:var(--modal-close-hover-color)}[type="checkbox"].modal:checked+div{display:flex;flex:0 1 auto;z-index:1200}[type="checkbox"].modal:checked+div .card .modal-close{z-index:1211}:root{--collapse-label-back-color:#e8e8e8;--collapse-label-fore-color:#212121;--collapse-label-hover-back-color:#f0f0f0;--collapse-selected-label-back-color:#ececec;--collapse-border-color:#ddd;--collapse-content-back-color:#fafafa;--collapse-selected-label-border-color:#0277bd}.collapse>:checked+label{background:var(--collapse-selected-label-back-color);border-bottom-color:var(--collapse-selected-label-border-color)}.collapse>:checked+label+div{box-sizing:border-box;position:relative;width:100%;height:auto;overflow:auto;margin:0;background:var(--collapse-content-back-color);border:.0625rem solid var(--collapse-border-color);border-top:0;padding:var(--universal-padding);clip:auto;-webkit-clip-path:inset(0%);clip-path:inset(0%);max-height:400px}:root{--progress-back-color:#ddd;--progress-fore-color:#555}:root{--spinner-back-color:#ddd;--spinner-fore-color:#555}:root{--generic-border-color:rgba(0,0,0,0.3);--generic-box-shadow:0 .25rem .25rem 0 rgba(0,0,0,0.125),0 .125rem .125rem -.125rem rgba(0,0,0,0.25)}
</style>
</head>
<body>
    <canvas id="myCanvas" width="240" height="240" style="display: none;"></canvas>
    <form id="display-form" autocomplete="off">
        <fieldset>
            <legend class="doc no-select">
                <span>屏幕设置</span>
                <label for="preset-toggle" style="padding: 0px; font-size: 0.6em;" class="button tertiary drawer-toggle persistent doc"><span style="font-size: 14px;">预设&nbsp;</span></label>
                <input type="checkbox" id="preset-toggle" class="drawer persistent">
                <div class="demo doc">
                    <label for="preset-toggle" class="drawer-close doc"></label>
                    <div style="padding: 10px;">预设屏幕配置</div>
                    <ul style="width: 70%;">
                        <li><input type="button" style="width: 100%;" onclick="setScreen(0)" class="tertiary" value="ST7789-240x240" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(1)" class="tertiary" value="ST7789-240x320-带CS" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(2)" class="tertiary" value="ST778V-135x240-带CS" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(3)" class="tertiary" value="ST7735S-128x160-带CS" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(4)" class="tertiary" value="ST7735S-80x160-带CS" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(6)" class="tertiary" value="ST7796-320x480-带CS" /></li>
                    </ul>
                </div>
            </legend>
            
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="display-type" class="doc">型号</label></div>
                <div class="col-sm-12 col-md">
                    <select id="display-type" style="width:85%;" class="doc">
                        <option class="doc">ST7735s</option>
                        <option class="doc">ST7789</option>
                        <option class="doc">ST7796</option>
                    </select>
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="screen-width" class="doc">宽度(px)</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="number" placeholder="width(px)" required value="" min="1" max="640" id="screen-width" style="width:85%;" class="doc">
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="screen-height" class="doc">高度(px)</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="number" placeholder="height(px)" required value="" min="1" max="640" id="screen-height" style="width:85%;" class="doc">
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="x-offset" class="doc">X偏移</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="number" placeholder="x offset" required value="0" min="0" max="255" id="x-offset" style="width:85%;" class="doc">
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="y-offset" class="doc">Y偏移</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="number" placeholder="y offset" required value="0" min="0" max="255" id="y-offset" style="width:85%;" class="doc">
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="check-cs" class="doc">使用CS</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="checkbox" autocomplete="off" id="check-cs" class="doc">
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="check-color_inversion" class="doc">反转色</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="checkbox" autocomplete="off" id="check-color_inversion" class="doc">
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="check-mirrored" class="doc">镜像</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="checkbox" autocomplete="off" id="check-mirrored" class="doc">
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="check-inclusive_end_coords" class="doc">结束坐标减1</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="checkbox" autocomplete="off" id="check-inclusive_end_coords" class="doc">
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="disp-rotation" class="doc">方向</label></div>
                <div class="col-sm-12 col-md">
                    <select id="disp-rotation" style="width:85%;" class="doc">
                        <option class="doc">0度</option>
                        <option class="doc">90度</option>
                        <option class="doc">180度</option>
                        <option class="doc">270度</option>
                    </select>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="color-order" class="doc">颜色顺序</label></div>
                <div class="col-sm-12 col-md">
                    <select id="color-order" style="width:85%;" class="doc">
                        <option class="doc">Rgb</option>
                        <option class="doc">Bgr</option>
                    </select>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="spi-mode" class="doc">SPI模式</label></div>
                <div class="col-sm-12 col-md">
                    <select id="spi-mode" style="width:85%;" class="doc">
                        <option class="doc">模式0</option>
                        <option class="doc">模式1</option>
                        <option class="doc">模式2</option>
                        <option class="doc">模式3</option>
                    </select>
                </div>
            </div>
        </fieldset>
        <div class="button-group">
            <button class="primary" type="submit">保存屏幕设置</button>
            &nbsp;<button class="tertiary" onclick="showTestDialog()" type="button">屏幕测试</button>
        </div>
    </form>
    <form id="wifi-form" autocomplete="off">
        <fieldset>
            <legend class="doc">网络设置</legend>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="ssid1-text" class="doc">Wi-Fi 名称 (SSID):</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" required="required" maxlength="32" type="text" placeholder="ssid" id="ssid1-text" style="width:85%;" class="doc"></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="ssid1-pwd" class="doc">Wi-Fi 密码</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" required="required" maxlength="32" placeholder="password" id="ssid1-pwd" style="width:85%;" class="doc"></div></div>

            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="deviceip-text" class="doc">设备IP:</label></div>
            <div class="col-sm-12 col-md"><input type="text" placeholder="wifi screen ip" id="deviceip-text" style="width:85%;" class="doc"></div></div>
            <!-- <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="gatewayip-text" class="doc">网关IP:</label></div>
            <div class="col-sm-12 col-md"><input type="text" placeholder="gateway ip" id="gatewayip-text" style="width:85%;" class="doc"></div></div> -->
        </fieldset>
        <div class="button-group">
            <button class="primary" type="submit">保存网络设置</button>
        </div>
    </form>

    <form id="mqtt-form" autocomplete="off">
        <fieldset>
            <legend class="doc">MQTT远程服务器设置</legend>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-url-text" class="doc">MQTT服务器:</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" maxlength="512" type="text" placeholder="例:mqtt://broker.emqx.io:1883" id="mqtt-url-text" style="width:85%;" class="doc"></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-id-text" class="doc">MQTT Client Id:</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" rows="10" maxlength="512" type="text" placeholder="Client Id" id="mqtt-id-text" style="width:85%;" class="doc"></input></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-username-text" class="doc">MQTT用户名:</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" rows="10" maxlength="512" type="text" placeholder="username" id="mqtt-username-text" style="width:85%;" class="doc"></input></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-password-text" class="doc">MQTT密码:</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" rows="10" maxlength="512" type="text" placeholder="password" id="mqtt-password-text" style="width:85%;" class="doc"></input></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-topic-text" class="doc">订阅主题(文本消息):</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" rows="10" maxlength="512" type="text" placeholder="Text Topic" id="mqtt-topic-text" style="width:85%;" class="doc"></input></div></div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="mqtt-qos" class="doc">Qos</label></div>
                <div class="col-sm-12 col-md">
                    <select id="mqtt-qos" style="width:85%;" class="doc">
                        <option class="doc">0</option>
                        <option class="doc">1</option>
                        <option class="doc">2</option>
                    </select>
                </div>
            </div>
        </fieldset>
        <div class="button-group">
            <button class="primary" type="submit">保存MQTT设置</button>
            <button class="tertiary" onclick="deleteMqttConfig()" type="button">删除MQTT设置</button>
        </div>
    </form>

    <input type="checkbox" id="loading-control" class="modal">
    <div>
        <div class="card">
            <h4 class="section">正在保存</h4>
            <p class="section">请稍候...</p>
        </div>
    </div>

    <input type="checkbox" id="modal-control" class="modal">
    <div>
        <div class="card">
            <label for="modal-control" class="modal-close" ></label>
            <h4 class="section">提示</h4>
            <p class="section" id="modal-text"></p>
        </div>
    </div>

    <script>
        function $(id){
            return document.getElementById(id);
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        var wifiConfigForm = $('wifi-form');
        var displayConfigForm = $('display-form');
        var wsserverConfigForm = $('wsserver-form');
        var mqttForm = $('mqtt-form');

        wifiConfigForm.addEventListener('submit', function(event) {
            event.preventDefault();
            submitWifiConfig();
        });

        mqttForm.addEventListener('submit', function(event){
            event.preventDefault();
            submitRemoteServerConfig();
        });

        displayConfigForm.addEventListener('submit', function(event) {
            event.preventDefault();
            submitDisplayConfig();
        });

        const checkLoading = $('loading-control');
        const dialog = $('modal-control');
        const dialogText = $('modal-text');

        function showTestDialog(){
            window.location.href = '/example';
        }

        async function generateJpegBlob(width, height, bgcolor, fgcolor, txt) {
            // 获取Canvas元素
            const canvas = document.getElementById('myCanvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // 设置背景颜色为蓝色
            ctx.fillStyle = bgcolor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 设置字体样式
            ctx.font = '28px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // 设置文字颜色为白色
            ctx.fillStyle = fgcolor;

            // 绘制文字
            ctx.fillText(txt, canvas.width / 2, canvas.height / 2);

            // 创建一个Promise来处理异步的toBlob回调函数
            return new Promise((resolve, reject) => {
                // 将Canvas内容导出为JPEG格式的Blob对象
                canvas.toBlob(blob => {
                    if (blob) {
                        resolve(blob);
                    } else {
                        reject(new Error('Failed to convert canvas to blob.'));
                    }
                }, 'image/jpeg', 0.9); // 第三个参数是质量（0到1之间）
            });
        }

        function showLoading(){
            checkLoading.checked = true;
        }
        function hideLoading(){
            checkLoading.checked = false;
        }

        function showDialog(msg){
            dialogText.innerHTML = msg;
            dialog.checked = true;
        }

        async function queryDisplayConfig() {
            var display_type = $('display-type');
            var screen_width = $('screen-width');
            var screen_height = $('screen-height');
            var x_offset = $('x-offset');
            var y_offset = $('y-offset');
            var check_cs = $('check-cs');
            var color_inversion = $('check-color_inversion');
            var mirrored = $('check-mirrored');
            var inclusive_end_coords = $('check-inclusive_end_coords');
            var spi_mode = $('spi-mode');
            var rotation = $('disp-rotation');
            var color_order = $('color-order');
            try{
                const response = await fetchWithTimeout('/display_config', {
                    method: 'GET'
                });
                let disp_config = JSON.parse(await response.text());
                if(disp_config != null){
                    if(disp_config.display_type != null && disp_config.display_type.trim().length>0){
                        display_type.value = disp_config.display_type;
                    }
                    if(disp_config.width != null && disp_config.width > 0){
                        screen_width.value = disp_config.width;
                    }
                    if(disp_config.height != null && disp_config.height > 0){
                        screen_height.value = disp_config.height;
                    }
                    x_offset.value = disp_config.x_offset || 0;
                    y_offset.value = disp_config.y_offset || 0;
                    check_cs.checked = disp_config.with_cs;
                    color_inversion.checked = disp_config.color_inversion;
                    rotation.selectedIndex = parseInt(parseInt(disp_config.rotation.replace('Deg', ''))/90);
                    mirrored.checked = disp_config.mirrored;
                    inclusive_end_coords.checked = disp_config.inclusive_end_coords;
                    spi_mode.selectedIndex = disp_config.spi_mode || 0;
                    if(disp_config.color_order != 'Rgb'){
                        color_order.selectedIndex = 1;
                    }else{
                        color_order.selectedIndex = 0;
                    }
                }
            }catch(e){
                console.log('wifi信息获取失败:', e);
            }
        }

        async function submitDisplayConfig(){
            var display_type = $('display-type');
            var screen_width = $('screen-width');
            var screen_height = $('screen-height');
            var x_offset = $('x-offset');
            var y_offset = $('y-offset');
            var check_cs = $('check-cs');
            var color_inversion = $('check-color_inversion');
            var mirrored = $('check-mirrored');
            var inclusive_end_coords = $('check-inclusive_end_coords');
            var spi_mode = $('spi-mode');
            var rotation = $('disp-rotation');
            var color_order = $('color-order');
            console.log('display_type:', display_type);
            console.log('spi_mode:', spi_mode);
            console.log('check_cs:', check_cs);

            showLoading();
            try{
                var colorOrderValue = 'Rgb';
                if(color_order.selectedIndex != 0){
                    colorOrderValue = 'Bgr'
                }
                const response = await fetch('/display_config', {
                    method: 'POST',
                    body: JSON.stringify({
                        display_type: display_type.value,
                        width: parseInt(screen_width.value),
                        height: parseInt(screen_height.value),
                        x_offset: parseInt(x_offset.value),
                        y_offset: parseInt(y_offset.value),
                        with_cs: check_cs.checked,
                        color_inversion: color_inversion.checked,
                        mirrored: mirrored.checked,
                        spi_mode: parseInt(spi_mode.selectedIndex),
                        rotation: 'Deg'+rotation.value.replace('度', ''),
                        color_order: colorOrderValue,
                        inclusive_end_coords: inclusive_end_coords.checked,
                    })
                });
                let text = await response.text();
                if (text != 'OK') {    
                    showDialog('保存失败:'+text);
                }else{
                    showDialog('保存成功，等待重启...');
                }
            }catch(e){
                showDialog('保存失败:'+e);
            }
            hideLoading();
        }

        async function queryWifiConfig() {
            try{
                const response = await fetchWithTimeout('/wifi_config', {
                    method: 'GET'
                });
                let wifi_config = JSON.parse(await response.text());
                if(wifi_config != null){
                    var ssid1 = $('ssid1-text');
                    var pwd1 = $('ssid1-pwd');
                    var deviceip = $('deviceip-text');
                    // var gatewayip = $('gatewayip-text');
                    if(wifi_config.ssid != null && wifi_config.ssid.trim().length>0){
                        ssid1.value = wifi_config.ssid;
                    }
                    if(wifi_config.password != null && wifi_config.password.trim().length>0){
                        pwd1.value = wifi_config.password;
                    }
                    if(wifi_config.device_ip != null && wifi_config.device_ip.trim().length>0){
                        deviceip.value = wifi_config.device_ip;
                    }
                    // if(wifi_config.gateway_ip != null && wifi_config.gateway_ip.trim().length>0){
                    //     gatewayip.value = wifi_config.gateway_ip;
                    // }
                }
            }catch(e){
                console.log('wifi信息获取失败:', e);
            }
        }

        async function submitWifiConfig(){
            var ssid1 = $('ssid1-text');
            var pwd1 = $('ssid1-pwd');
            var deviceip = $('deviceip-text');
            // var gatewayip = $('gatewayip-text');
            
            console.log('ssid1='+ssid1.value);
            console.log('pwd1='+pwd1.value);
            console.log('deviceip='+deviceip.value);
            // console.log('gatewayip='+gatewayip.value);

            showLoading();
            try{
                var cfg = {
                    ssid: ssid1.value,
                    password: pwd1.value
                };
                
                if(deviceip.value.trim().length>0){
                    cfg.device_ip = deviceip.value;
                }
                // if(gatewayip.value.trim().length>0){
                //     cfg.gateway_ip = gatewayip.value;
                // }
                
                const response = await fetchWithTimeout('/wifi_config', {
                    method: 'POST',
                    body: JSON.stringify(cfg)
                });

                let text = await response.text();
                if (text != 'OK') {    
                    showDialog('保存失败:'+text);
                }else{
                    showDialog('保存成功，等待重启...');
                }
            }catch(e){
                showDialog('保存失败:'+e);
            }
            hideLoading();
        }

        async function queryRemoteServerConfig() {
            try{
                const response = await fetchWithTimeout('/remote_server_config', {
                    method: 'GET'
                });
                let remote_server_config = JSON.parse(await response.text());
                console.log('queryRemoteServerConfig:', remote_server_config);
                if(remote_server_config != null){
                    var txtMqttUrl = $('mqtt-url-text');
                    var txtMqttClientId = $('mqtt-id-text');
                    var txtMqttUserName = $('mqtt-username-text');
                    var txtMqttPassword = $('mqtt-password-text');
                    var txtMqttTopic = $('mqtt-topic-text');
                    var selectMqttQos = $('mqtt-qos');
                    txtMqttUrl.value = remote_server_config.mqtt_url || '';
                    txtMqttClientId.value = remote_server_config.mqtt_client_id || '';
                    txtMqttUserName.value = remote_server_config.mqtt_username || '';
                    txtMqttPassword.value = remote_server_config.mqtt_password || '';
                    txtMqttTopic.value = remote_server_config.mqtt_topic || '';
                    if(remote_server_config.mqtt_qos == 'AtMostOnce'){
                        selectMqttQos.selectedIndex = 0;
                    }else if(remote_server_config.mqtt_qos == 'AtLeastOnce'){
                        selectMqttQos.selectedIndex = 1;
                    }else if(remote_server_config.mqtt_qos == 'ExactlyOnce'){
                        selectMqttQos.selectedIndex = 2;
                    }
                }
            }catch(e){
                console.log('远程服务器配置信息获取失败:', e);
            }
        }

        async function deleteMqttConfig() {
            const isConfirmed = window.confirm("你确定要删除MQTT配置吗？");
            if(!isConfirmed){
                return;
            }
            showLoading();
            try{
                const response = await fetchWithTimeout('/delete_remote_server_config', {
                    method: 'GET'
                });

                let text = await response.text();
                if (text != 'OK') {    
                    showDialog('删除失败:'+text);
                }else{
                    showDialog('删除成功，等待重启...');
                }
            }catch(e){
                showDialog('删除失败:'+e);
            }
            hideLoading();
        }

        
        async function submitRemoteServerConfig(){
            var txtMqttUrl = $('mqtt-url-text');
            var txtMqttClientId = $('mqtt-id-text');
            var txtMqttUserName = $('mqtt-username-text');
            var txtMqttPassword = $('mqtt-password-text');
            var txtMqttTopic = $('mqtt-topic-text');
            var selectMqttQos = $('mqtt-qos');

            var mqtt_qos = 'AtMostOnce';
            console.log('selectMqttQos.selectedIndex==='+selectMqttQos.selectedIndex);
            if(selectMqttQos.selectedIndex == 1){
                mqtt_qos = 'AtLeastOnce';
            }else if(selectMqttQos.selectedIndex == 2) {
                mqtt_qos = 'ExactlyOnce';
            }

            showLoading();
            try{
                var cfg = {
                    mqtt_qos
                };
                if (txtMqttUrl.value.trim().length > 0){
                    cfg.mqtt_url = txtMqttUrl.value;
                }
                if(txtMqttClientId.value.trim().length>0){
                    cfg.mqtt_client_id = txtMqttClientId.value;
                }
                if(txtMqttUserName.value.trim().length>0){
                    cfg.mqtt_username = txtMqttUserName.value;
                }
                if(txtMqttPassword.value.trim().length>0){
                    cfg.mqtt_password = txtMqttPassword.value;
                }
                if(txtMqttTopic.value.trim().length>0){
                    cfg.mqtt_topic = txtMqttTopic.value;
                }
                
                const response = await fetchWithTimeout('/remote_server_config', {
                    method: 'POST',
                    body: JSON.stringify(cfg)
                });

                let text = await response.text();
                if (text != 'OK') {    
                    showDialog('保存失败:'+text);
                }else{
                    showDialog('保存成功，等待重启...');
                }
            }catch(e){
                showDialog('保存失败:'+e);
            }
            hideLoading();
        }

        function setScreen(index){
            $('preset-toggle').checked = false;

            var display_type = $('display-type');
            var screen_width = $('screen-width');
            var screen_height = $('screen-height');
            var x_offset = $('x-offset');
            var y_offset = $('y-offset');
            var check_cs = $('check-cs');
            var color_inversion = $('check-color_inversion');
            var inclusive_end_coords = $('check-inclusive_end_coords');
            var spi_mode = $('spi-mode');
            var rotation = $('disp-rotation');
            var mirrored = $('check-mirrored'); 
            var color_order = $('color-order');
            /*
            display_type:
            0 <=> ST7735s
            1 <=> ST7789
            2 <=> ST7796
            */
            if(index == 0){
                //ST7789-240x240不带CS
                display_type.selectedIndex = 1;
                screen_width.value = 240;
                screen_height.value = 240;
                color_inversion.checked = true;
                check_cs.checked = false;
                x_offset.value = 0;
                y_offset.value = 0;
                spi_mode.selectedIndex = 3;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 0;
                inclusive_end_coords.checked = false;
            }
            if(index == 1){
                //ST7789-240x320带CS
                display_type.selectedIndex = 1;
                screen_width.value = 240;
                screen_height.value = 320;
                color_inversion.checked = false;
                check_cs.checked = true;
                x_offset.value = 0;
                y_offset.value = 0;
                spi_mode.selectedIndex = 3;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 0;
                inclusive_end_coords.checked = false;
            }
            if(index == 2){
                //ST7789V-135x240带CS
                display_type.selectedIndex = 1;
                screen_width.value = 135;
                screen_height.value = 240;
                color_inversion.checked = true;
                check_cs.checked = true;
                x_offset.value = 52;
                y_offset.value = 40;
                spi_mode.selectedIndex = 0;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 0;
                inclusive_end_coords.checked = true;
            }
            if(index == 3){
                //ST7735S-128x160带CS
                display_type.selectedIndex = 0;
                screen_width.value = 128;
                screen_height.value = 160;
                color_inversion.checked = false;
                check_cs.checked = true;
                x_offset.value = 0;
                y_offset.value = 0;
                spi_mode.selectedIndex = 0;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 0;
                inclusive_end_coords.checked = false;
            }
            if(index == 4){
                //ST7735S-80x160带CS
                display_type.selectedIndex = 0;
                screen_width.value = 80;
                screen_height.value = 160;
                color_inversion.checked = true;
                check_cs.checked = true;
                x_offset.value = 26;
                y_offset.value = 0;
                spi_mode.selectedIndex = 0;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 1;
                inclusive_end_coords.checked = true;
            }
            if(index == 6){
                //ST7796-320x480带CS
                display_type.selectedIndex = 2;
                screen_width.value = 320;
                screen_height.value = 480;
                color_inversion.checked = false;
                check_cs.checked = true;
                x_offset.value = 0;
                y_offset.value = 0;
                spi_mode.selectedIndex = 3;
                rotation.selectedIndex = 0;
                mirrored.checked = true;
                color_order.selectedIndex = 1;
                inclusive_end_coords.checked = false;
            }
        }

        async function fetchWithTimeout(url, options = {}, timeout = 5000) {
            // 创建一个AbortController实例
            const controller = new AbortController();
            const { signal } = controller;

            // 设置超时
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, timeout);

            try {
                // 发起fetch请求，并传递signal以允许取消请求
                const response = await Promise.race([
                    fetch(url, { ...options, signal }),
                    new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Request timed out')), timeout)
                    )
                ]);

                // 清除超时定时器
                clearTimeout(timeoutId);

                return response;
            } catch (error) {
                // 清除超时定时器
                clearTimeout(timeoutId);

                if (error.name === 'AbortError') {
                    throw new Error('Request aborted due to timeout');
                }

                throw error; // 抛出其他错误
            }
        }

        queryWifiConfig();
        queryDisplayConfig();
        queryRemoteServerConfig();
    </script>
</body>
</html>