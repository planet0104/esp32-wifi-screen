## 安装步骤

### 方式一：使用 espup 安装（推荐）

1. **安装 espup 工具**
   ```powershell
   cargo +stable install espup
   ```

2. **安装 ldproxy 链接器**
   ```powershell
   # 临时取消项目的工具链覆盖
   rustup override unset
   
   # 安装 ldproxy
   cargo install ldproxy
   
   # 恢复项目的 esp 工具链
   rustup override set esp
   ```

3. **安装 ESP Rust 工具链**
   ```powershell
   espup install
   ```
   注意：如果安装过程卡住超过5分钟，按 Ctrl+C 中断即可，工具链已经安装成功。

4. **配置项目**
   
   a) **设置短路径编译目录**（解决长路径问题）
   
   编辑 `.cargo/config.toml`，添加：
   ```toml
   [build]
   target = "xtensa-esp32s2-espidf"
   target-dir = "C:/esp/target"  # 使用短路径作为编译输出目录
   ```

   b) **配置 sdkconfig 路径**
   
   在 `.cargo/config.toml` 的 `[env]` 部分添加：
   ```toml
   [env]
   MCU="esp32s2"
   ESP_IDF_VERSION = "v5.3.2"
   ESP_IDF_SDKCONFIG_DEFAULTS = { value = "sdkconfig.defaults", relative = true }
   ```

   c) **配置库文件路径**
   
   在 `.cargo/config.toml` 的 `rustflags` 中，将库路径设置为项目的实际路径：
   ```toml
   [target.xtensa-esp32s2-espidf]
   rustflags = [
       "--cfg",  "espidf_time64",
       "-L", "C:/Users/你的用户名/Documents/GitHub/esp32-wifi-screen/scr/library",
       "-l", "tjpgd"
   ]
   ```
   
   > **注意**：将路径中的"你的用户名"替换为实际的用户名，或使用相对路径

5. **每次编译前设置环境变量**
   ```powershell
   . .\espup_env.ps1
   ```

6. **编译和烧写**
   ```powershell
   # 编译
   cargo build --release
   
   # 烧写（修改 flash.ps1 中的串口名称）
   .\flash.ps1
   ```
   
   **首次编译注意**：
   - 首次执行 `cargo build` 会从 GitHub 克隆相关库到 `C:/esp/.embuild` 文件夹
   - **必须开启 Clash 全局代理**，否则会克隆失败
   - 首次编译耗时较久（10-30分钟），请耐心等待

### 方式二：使用 ESP-IDF 官方安装器

1. **下载并安装 ESP-IDF 5.3**
   - 官网：https://dl.espressif.com.cn/dl/esp-idf/index.html
   - 可选择安装 Rust 相关组件（需要全局代理）
   - 或不选择 Rust 组件，手动安装（推荐方式一）

2. **使用 ESP-IDF 控制台**
   - 打开 ESP-IDF 5.3 CMD 控制台
   - 进入项目目录
   - 执行 `code .` 打开项目

### 注意事项

- **库路径配置**：确保 `.cargo/config.toml` 中 `-L` 参数指向正确的 `library` 目录
- **sdkconfig 配置**：`ESP_IDF_SDKCONFIG_DEFAULTS` 需要正确指向 `sdkconfig.defaults` 文件
- **编译输出目录**：`target-dir = "C:/esp/target"` 避免了路径过长的问题
- **串口配置**：烧写时修改 `flash.ps1` 中的串口名称