<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32-WiFiScreen</title>
<style>
    .no-select{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
    
:root{--fore-color:#111;--secondary-fore-color:#444;--back-color:#f8f8f8;--secondary-back-color:#f0f0f0;--blockquote-color:#f57c00;--pre-color:#1565c0;--border-color:#aaa;--secondary-border-color:#ddd;--heading-ratio:1.19;--universal-margin:.5rem;--universal-padding:.5rem;--universal-border-radius:.125rem;--a-link-color:#0277bd;--a-visited-color:#01579b}html{font-size:16px}span{font-size:1em}html,*{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Helvetica, sans-serif;line-height:1.5;-webkit-text-size-adjust:100%}*{font-size:1rem}body{margin:0;color:var(--fore-color);background:var(--back-color)}input{overflow:visible}h4{line-height:1.2;margin:calc(1.5 * var(--universal-margin)) var(--universal-margin);font-weight:500}h4{font-size:calc(1rem * var(--heading-ratio))}p{margin:var(--universal-margin)}ul{margin:var(--universal-margin);padding-left:calc(2 * var(--universal-margin))}.row{box-sizing:border-box;display:flex;flex:0 1 auto;flex-flow:row wrap}[class^='col-sm-']{box-sizing:border-box;flex:0 0 auto;padding:0 calc(var(--universal-padding) / 2)}.col-sm-12{max-width:100%;flex-basis:100%}@media screen and (min-width: 768px){.col-md{box-sizing:border-box;flex:0 0 auto;padding:0 calc(var(--universal-padding) / 2)}.col-md{max-width:100%;flex-grow:1;flex-basis:0}.col-md-3{max-width:25%;flex-basis:25%}}:root{--card-back-color:#f8f8f8;--card-fore-color:#111;--card-border-color:#ddd}.card{display:flex;flex-direction:column;justify-content:space-between;align-self:center;position:relative;width:100%;background:var(--card-back-color);color:var(--card-fore-color);border:.0625rem solid var(--card-border-color);border-radius:var(--universal-border-radius);margin:var(--universal-margin);overflow:hidden}@media screen and (min-width: 320px){.card{max-width:320px}}.card>.section{background:var(--card-back-color);color:var(--card-fore-color);box-sizing:border-box;margin:0;border:0;border-radius:0;border-bottom:.0625rem solid var(--card-border-color);padding:var(--universal-padding);width:100%}.card>.section:last-child{border-bottom:0}:root{--form-back-color:#f0f0f0;--form-fore-color:#111;--form-border-color:#ddd;--input-back-color:#f8f8f8;--input-fore-color:#111;--input-border-color:#ddd;--input-focus-color:#0288d1;--input-invalid-color:#d32f2f;--button-back-color:#e2e2e2;--button-hover-back-color:#dcdcdc;--button-fore-color:#212121;--button-border-color:rgba(0,0,0,0);--button-hover-border-color:rgba(0,0,0,0);--button-group-border-color:rgba(124,124,124,0.54)}form{background:var(--form-back-color);color:var(--form-fore-color);border:.0625rem solid var(--form-border-color);border-radius:var(--universal-border-radius);margin:var(--universal-margin);padding:calc(2 * var(--universal-padding)) var(--universal-padding)}fieldset{border:.0625rem solid var(--form-border-color);border-radius:var(--universal-border-radius);margin:calc(var(--universal-margin) / 4);padding:var(--universal-padding)}legend{box-sizing:border-box;display:table;max-width:100%;white-space:normal;font-weight:700;padding:calc(var(--universal-padding) / 2)}label{padding:calc(var(--universal-padding) / 2) var(--universal-padding)}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}input:not([type]),[type="text"],[type="number"],[type="checkbox"],select{box-sizing:border-box;background:var(--input-back-color);color:var(--input-fore-color);border:.0625rem solid var(--input-border-color);border-radius:var(--universal-border-radius);margin:calc(var(--universal-margin) / 2);padding:var(--universal-padding) calc(1.5 * var(--universal-padding))}input:not([type="button"]):not([type="submit"]):not([type="reset"]):hover,input:not([type="button"]):not([type="submit"]):not([type="reset"]):focus,select:hover,select:focus{border-color:var(--input-focus-color);box-shadow:none}input:not([type="button"]):not([type="submit"]):not([type="reset"]):invalid,input:not([type="button"]):not([type="submit"]):not([type="reset"]):focus:invalid,select:invalid,select:focus:invalid{border-color:var(--input-invalid-color);box-shadow:none}select{max-width:100%}option{overflow:hidden;text-overflow:ellipsis}[type="checkbox"]{-webkit-appearance:none;-moz-appearance:none;appearance:none;position:relative;height:calc(1rem + var(--universal-padding) / 2);width:calc(1rem + var(--universal-padding) / 2);vertical-align:text-bottom;padding:0;flex-basis:calc(1rem + var(--universal-padding) / 2) !important;flex-grow:0 !important}[type="checkbox"]:checked:before{position:absolute}[type="checkbox"]:checked:before{content:'\2713';font-family:sans-serif;font-size:calc(1rem + var(--universal-padding) / 2);top:calc(0rem - var(--universal-padding));left:calc(var(--universal-padding) / 4)}:placeholder-shown{color:var(--input-fore-color)}::-ms-placeholder{color:var(--input-fore-color);opacity:0.54}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button,html [type="button"],[type="submit"]{-webkit-appearance:button}button{overflow:visible;text-transform:none}button,[type="button"],[type="submit"],label.button,.button{display:inline-block;background:var(--button-back-color);color:var(--button-fore-color);border:.0625rem solid var(--button-border-color);border-radius:var(--universal-border-radius);padding:var(--universal-padding) calc(1.5 * var(--universal-padding));margin:var(--universal-margin);text-decoration:none;cursor:pointer;transition:background 0.3s}button:hover,button:focus,[type="button"]:hover,[type="button"]:focus,[type="submit"]:hover,[type="submit"]:focus,label.button:hover,label.button:focus,.button:hover,.button:focus{background:var(--button-hover-back-color);border-color:var(--button-hover-border-color)}input:disabled,select:disabled,button:disabled,.button:disabled{cursor:not-allowed;opacity:.75}.button-group{display:flex;border:.0625rem solid var(--button-group-border-color);border-radius:var(--universal-border-radius);margin:var(--universal-margin)}.button-group>button,.button-group [type="button"],.button-group>[type="submit"]{margin:0;max-width:100%;flex:1 1 auto;text-align:center;border:0;border-radius:0;box-shadow:none}.button-group>:not(:first-child){border-left:.0625rem solid var(--button-group-border-color)}@media screen and (max-width: 767px){.button-group{flex-direction:column}.button-group>:not(:first-child){border:0;border-top:.0625rem solid var(--button-group-border-color)}}button.primary,[type="submit"].primary{--button-back-color:#1976d2;--button-fore-color:#f8f8f8}button.primary:hover,button.primary:focus,[type="submit"].primary:hover,[type="submit"].primary:focus{--button-hover-back-color:#1565c0}button.tertiary,[type="button"].tertiary,.button.tertiary{--button-back-color:#308732;--button-fore-color:#f8f8f8}button.tertiary:hover,button.tertiary:focus,[type="button"].tertiary:hover,[type="button"].tertiary:focus,.button.tertiary:hover,.button.tertiary:focus{--button-hover-back-color:#277529}:root{--header-back-color:#f8f8f8;--header-hover-back-color:#f0f0f0;--header-fore-color:#444;--header-border-color:#ddd;--nav-back-color:#f8f8f8;--nav-hover-back-color:#f0f0f0;--nav-fore-color:#444;--nav-border-color:#ddd;--nav-link-color:#0277bd;--footer-fore-color:#444;--footer-back-color:#f8f8f8;--footer-border-color:#ddd;--footer-link-color:#0277bd;--drawer-back-color:#f8f8f8;--drawer-hover-back-color:#f0f0f0;--drawer-border-color:#ddd;--drawer-close-color:#444}.drawer-toggle:before{display:inline-block;position:relative;vertical-align:bottom;content:'\00a0\2261\00a0';font-family:sans-serif;font-size:1.5em}[type="checkbox"].drawer{height:1px;width:1px;margin:-1px;overflow:hidden;position:absolute;clip:rect(0 0 0 0);-webkit-clip-path:inset(100%);clip-path:inset(100%)}[type="checkbox"].drawer+*{display:block;box-sizing:border-box;position:fixed;top:0;width:320px;height:100vh;overflow-y:auto;background:var(--drawer-back-color);border:.0625rem solid var(--drawer-border-color);border-radius:0;margin:0;z-index:1110;right:-320px;transition:right 0.3s}[type="checkbox"].drawer+* .drawer-close{position:absolute;top:var(--universal-margin);right:var(--universal-margin);z-index:1111;width:2rem;height:2rem;border-radius:var(--universal-border-radius);padding:var(--universal-padding);margin:0;cursor:pointer;transition:background 0.3s}[type="checkbox"].drawer+* .drawer-close:before{display:block;content:'\00D7';color:var(--drawer-close-color);position:relative;font-family:sans-serif;font-size:2rem;line-height:1;text-align:center}[type="checkbox"].drawer+* .drawer-close:hover,[type="checkbox"].drawer+* .drawer-close:focus{background:var(--drawer-hover-back-color)}@media screen and (max-width: 320px){[type="checkbox"].drawer+*{width:100%}}[type="checkbox"].drawer:checked+*{right:0}:root{--table-border-color:#aaa;--table-border-separator-color:#666;--table-head-back-color:#e6e6e6;--table-head-fore-color:#111;--table-body-back-color:#f8f8f8;--table-body-fore-color:#111;--table-body-alt-back-color:#eee}:root{--table-body-alt-back-color:#eee}:root{--table-body-hover-back-color:#90caf9}:root{--mark-back-color:#0277bd;--mark-fore-color:#fafafa}:root{--toast-back-color:#424242;--toast-fore-color:#fafafa}:root{--tooltip-back-color:#212121;--tooltip-fore-color:#fafafa}:root{--modal-overlay-color:rgba(0,0,0,0.45);--modal-close-color:#444;--modal-close-hover-color:#f0f0f0}[type="checkbox"].modal{height:1px;width:1px;margin:-1px;overflow:hidden;position:absolute;clip:rect(0 0 0 0);-webkit-clip-path:inset(100%);clip-path:inset(100%)}[type="checkbox"].modal+div{position:fixed;top:0;left:0;display:none;width:100vw;height:100vh;background:var(--modal-overlay-color)}[type="checkbox"].modal+div .card{margin:0 auto;max-height:50vh;overflow:auto}[type="checkbox"].modal+div .card .modal-close{position:absolute;top:0;right:0;width:1.75rem;height:1.75rem;border-radius:var(--universal-border-radius);padding:var(--universal-padding);margin:0;cursor:pointer;transition:background 0.3s}[type="checkbox"].modal+div .card .modal-close:before{display:block;content:'\00D7';color:var(--modal-close-color);position:relative;font-family:sans-serif;font-size:1.75rem;line-height:1;text-align:center}[type="checkbox"].modal+div .card .modal-close:hover,[type="checkbox"].modal+div .card .modal-close:focus{background:var(--modal-close-hover-color)}[type="checkbox"].modal:checked+div{display:flex;flex:0 1 auto;z-index:1200}[type="checkbox"].modal:checked+div .card .modal-close{z-index:1211}:root{--collapse-label-back-color:#e8e8e8;--collapse-label-fore-color:#212121;--collapse-label-hover-back-color:#f0f0f0;--collapse-selected-label-back-color:#ececec;--collapse-border-color:#ddd;--collapse-content-back-color:#fafafa;--collapse-selected-label-border-color:#0277bd}.collapse>:checked+label{background:var(--collapse-selected-label-back-color);border-bottom-color:var(--collapse-selected-label-border-color)}.collapse>:checked+label+div{box-sizing:border-box;position:relative;width:100%;height:auto;overflow:auto;margin:0;background:var(--collapse-content-back-color);border:.0625rem solid var(--collapse-border-color);border-top:0;padding:var(--universal-padding);clip:auto;-webkit-clip-path:inset(0%);clip-path:inset(0%);max-height:400px}:root{--progress-back-color:#ddd;--progress-fore-color:#555}:root{--spinner-back-color:#ddd;--spinner-fore-color:#555}:root{--generic-border-color:rgba(0,0,0,0.3);--generic-box-shadow:0 .25rem .25rem 0 rgba(0,0,0,0.125),0 .125rem .125rem -.125rem rgba(0,0,0,0.25)}
</style>
</head>
<body>
    <canvas id="myCanvas" width="240" height="240" style="display: none;"></canvas>
    <form id="display-form" autocomplete="off">
        <fieldset>
            <legend class="doc no-select">
                <span>å±å¹•è®¾ç½®</span>
                <label for="preset-toggle" style="padding: 0px; font-size: 0.6em;" class="button tertiary drawer-toggle persistent doc"><span style="font-size: 14px;">é¢„è®¾&nbsp;</span></label>
                <input type="checkbox" id="preset-toggle" class="drawer persistent">
                <div class="demo doc">
                    <label for="preset-toggle" class="drawer-close doc"></label>
                    <div style="padding: 10px;">é¢„è®¾å±å¹•é…ç½®</div>
                    <ul style="width: 70%;">
                        <li><input type="button" style="width: 100%;" onclick="setScreen(0)" class="tertiary" value="ST7789-240x240" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(1)" class="tertiary" value="ST7789-240x320-å¸¦CS" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(2)" class="tertiary" value="ST778V-135x240-å¸¦CS" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(3)" class="tertiary" value="ST7735S-128x160-å¸¦CS" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(4)" class="tertiary" value="ST7735S-80x160-å¸¦CS" /></li>
                        <li><input type="button" style="width: 100%;" onclick="setScreen(6)" class="tertiary" value="ST7796-320x480-å¸¦CS" /></li>
                    </ul>
                </div>
            </legend>
            
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="display-type" class="doc">å‹å·</label></div>
                <div class="col-sm-12 col-md">
                    <select id="display-type" style="width:85%;" class="doc">
                        <option class="doc">ST7735s</option>
                        <option class="doc">ST7789</option>
                        <option class="doc">ST7796</option>
                    </select>
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="screen-width" class="doc">å®½åº¦(px)</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="number" placeholder="width(px)" required value="" min="1" max="640" id="screen-width" style="width:85%;" class="doc">
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="screen-height" class="doc">é«˜åº¦(px)</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="number" placeholder="height(px)" required value="" min="1" max="640" id="screen-height" style="width:85%;" class="doc">
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="x-offset" class="doc">Xåç§»</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="number" placeholder="x offset" required value="0" min="0" max="255" id="x-offset" style="width:85%;" class="doc">
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="y-offset" class="doc">Yåç§»</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="number" placeholder="y offset" required value="0" min="0" max="255" id="y-offset" style="width:85%;" class="doc">
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="check-cs" class="doc">ä½¿ç”¨CS</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="checkbox" autocomplete="off" id="check-cs" class="doc">
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="check-color_inversion" class="doc">åè½¬è‰²</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="checkbox" autocomplete="off" id="check-color_inversion" class="doc">
                </div>
            </div>

            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="check-mirrored" class="doc">é•œåƒ</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="checkbox" autocomplete="off" id="check-mirrored" class="doc">
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="check-inclusive_end_coords" class="doc">ç»“æŸåæ ‡å‡1</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="checkbox" autocomplete="off" id="check-inclusive_end_coords" class="doc">
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="disp-rotation" class="doc">æ–¹å‘</label></div>
                <div class="col-sm-12 col-md">
                    <select id="disp-rotation" style="width:85%;" class="doc" onchange="applyRotationRealtime()">
                        <option class="doc">0åº¦</option>
                        <option class="doc">90åº¦</option>
                        <option class="doc">180åº¦</option>
                        <option class="doc">270åº¦</option>
                    </select>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="color-order" class="doc">é¢œè‰²é¡ºåº</label></div>
                <div class="col-sm-12 col-md">
                    <select id="color-order" style="width:85%;" class="doc">
                        <option class="doc">Rgb</option>
                        <option class="doc">Bgr</option>
                    </select>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="spi-mode" class="doc">SPIæ¨¡å¼</label></div>
                <div class="col-sm-12 col-md">
                    <select id="spi-mode" style="width:85%;" class="doc">
                        <option class="doc">æ¨¡å¼0</option>
                        <option class="doc">æ¨¡å¼1</option>
                        <option class="doc">æ¨¡å¼2</option>
                        <option class="doc">æ¨¡å¼3</option>
                    </select>
                </div>
            </div>
        </fieldset>
        <div class="button-group">
            <button class="primary" type="submit">ä¿å­˜å±å¹•è®¾ç½®</button>
            &nbsp;<button class="tertiary" onclick="showTestDialog()" type="button">å±å¹•æµ‹è¯•</button>
        </div>
    </form>
    
    <form id="color-adjust-form" autocomplete="off">
        <fieldset>
            <legend class="doc no-select">è‰²è°ƒè°ƒæ•´ (æ‹–åŠ¨æ»‘å—å®æ—¶ç”Ÿæ•ˆ)</legend>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label class="doc">å¿«æ·é¢„è®¾:</label></div>
                <div class="col-sm-12 col-md">
                    <button class="tertiary" onclick="applyColorPreset('fix-blue')" type="button" style="font-size:0.85em;padding:4px 8px;margin:2px;">ä¿®å¤åè“</button>
                    <button class="tertiary" onclick="applyColorPreset('fix-yellow')" type="button" style="font-size:0.85em;padding:4px 8px;margin:2px;">ä¿®å¤åé»„</button>
                    <button class="tertiary" onclick="applyColorPreset('warm')" type="button" style="font-size:0.85em;padding:4px 8px;margin:2px;">æš–è‰²è°ƒ</button>
                    <button class="tertiary" onclick="applyColorPreset('cool')" type="button" style="font-size:0.85em;padding:4px 8px;margin:2px;">å†·è‰²è°ƒ</button>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="color-adjust-r" class="doc">çº¢è‰² (R)</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="range" id="color-adjust-r" min="-100" max="100" value="0" step="1" style="width:70%;" class="doc">
                    <span id="color-adjust-r-value" style="display:inline-block; width:50px; text-align:right; font-weight:bold; color:#f44336;">0</span>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="color-adjust-g" class="doc">ç»¿è‰² (G)</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="range" id="color-adjust-g" min="-100" max="100" value="0" step="1" style="width:70%;" class="doc">
                    <span id="color-adjust-g-value" style="display:inline-block; width:50px; text-align:right; font-weight:bold; color:#4caf50;">0</span>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="color-adjust-b" class="doc">è“è‰² (B)</label>
                </div>
                <div class="col-sm-12 col-md">
                    <input type="range" id="color-adjust-b" min="-100" max="100" value="0" step="1" style="width:70%;" class="doc">
                    <span id="color-adjust-b-value" style="display:inline-block; width:50px; text-align:right; font-weight:bold; color:#2196f3;">0</span>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"></div>
                <div class="col-sm-12 col-md">
                    <small style="color:#666;">ğŸ’¡ è°ƒæ•´èŒƒå›´: -100 åˆ° +100ã€‚æ‹–åŠ¨æ»‘å—æ—¶ä¼šè‡ªåŠ¨åº”ç”¨ï¼Œå±å¹•ä¼šå®æ—¶åˆ·æ–°æ˜¾ç¤ºæ•ˆæœ</small>
                </div>
            </div>
        </fieldset>
        <div style="text-align: center; padding: 10px;">
            <button class="tertiary" onclick="resetColorAdjust()" type="button">é‡ç½®ä¸º0</button>
        </div>
    </form>
    
    <!-- =================================================================== -->
    <!-- å±å¹•èƒŒå…‰äº®åº¦æ§åˆ¶è¡¨å•                                                  -->
    <!-- =================================================================== -->
    <!-- å®ç°è¦ç‚¹cï¼šhttp_server.rså’Œindex.htmlä¸­ä¿®æ”¹åäº®åº¦å¹¶å®æ—¶åˆ·æ–°äº®åº¦      -->
    <!--                                                                      -->
    <!-- åŠŸèƒ½è¯´æ˜ï¼š                                                            -->
    <!-- - æä¾›æ»‘å—å’ŒæŒ‰é’®ä¸¤ç§æ–¹å¼è°ƒèŠ‚äº®åº¦                                     -->
    <!-- - æ”¯æŒ0-100%èŒƒå›´è°ƒèŠ‚                                                 -->
    <!-- - æ‹–åŠ¨æ»‘å—å®æ—¶ç”Ÿæ•ˆï¼ˆé˜²æŠ–250msï¼‰                                      -->
    <!-- - æä¾›4ä¸ªå¿«æ·é¢„è®¾æŒ‰é’®ï¼ˆ25%, 50%, 75%, 100%ï¼‰                        -->
    <!-- - å½“å‰äº®åº¦å€¼å®æ—¶æ˜¾ç¤º                                                 -->
    <!-- - é‡ç½®æŒ‰é’®å¯å¿«é€Ÿæ¢å¤åˆ°100%                                           -->
    <!--                                                                      -->
    <!-- æŠ€æœ¯å®ç°ï¼š                                                            -->
    <!-- - æ»‘å—inputäº‹ä»¶è§¦å‘applyBrightnessRealtime()                        -->
    <!-- - é˜²æŠ–å¤„ç†é˜²æ­¢é¢‘ç¹è¯·æ±‚ï¼ˆ250mså»¶è¿Ÿï¼‰                                 -->
    <!-- - å‘é€POST /brightnessè¯·æ±‚åˆ°ESP32                                  -->
    <!-- - ESP32é€šè¿‡GPIO13 PWMå®æ—¶è°ƒèŠ‚å±å¹•äº®åº¦                               -->
    <!-- - åŒæ—¶åœ¨å±å¹•ä¸Šæ˜¾ç¤º"Brightness: XX%"æç¤º                             -->
    <!-- - äº®åº¦å€¼è‡ªåŠ¨ä¿å­˜åˆ°NVSï¼Œé‡å¯åæ¢å¤                                   -->
    <!--                                                                      -->
    <form id="brightness-form" autocomplete="off">
        <fieldset>
            <legend class="doc no-select">å±å¹•äº®åº¦ (æ‹–åŠ¨æ»‘å—å®æ—¶ç”Ÿæ•ˆ)</legend>
            
            <!-- å¿«æ·é¢„è®¾æŒ‰é’®ç»„ -->
            <!-- ç‚¹å‡»åç›´æ¥åº”ç”¨é¢„è®¾äº®åº¦å€¼ï¼Œæ— éœ€æ‹–åŠ¨æ»‘å— -->
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label class="doc">å¿«æ·é¢„è®¾:</label></div>
                <div class="col-sm-12 col-md">
                    <!-- 100%äº®åº¦ - é€‚åˆæˆ·å¤–å¼ºå…‰ç¯å¢ƒ -->
                    <button class="tertiary" onclick="applyBrightnessPreset(100)" type="button" style="font-size:0.85em;padding:4px 8px;margin:2px;">100%</button>
                    <!-- 75%äº®åº¦ - é€‚åˆæ˜äº®å®¤å†…ç¯å¢ƒ -->
                    <button class="tertiary" onclick="applyBrightnessPreset(75)" type="button" style="font-size:0.85em;padding:4px 8px;margin:2px;">75%</button>
                    <!-- 50%äº®åº¦ - é€‚åˆæ™®é€šå®¤å†…ç¯å¢ƒ -->
                    <button class="tertiary" onclick="applyBrightnessPreset(50)" type="button" style="font-size:0.85em;padding:4px 8px;margin:2px;">50%</button>
                    <!-- 25%äº®åº¦ - é€‚åˆæš—å…‰ç¯å¢ƒï¼ˆå¦‚å¤œæ™šï¼‰ -->
                    <button class="tertiary" onclick="applyBrightnessPreset(25)" type="button" style="font-size:0.85em;padding:4px 8px;margin:2px;">25%</button>
                </div>
            </div>
            
            <!-- äº®åº¦æ»‘å—æ§åˆ¶ -->
            <!-- æ‹–åŠ¨æ—¶å®æ—¶å‘é€è¯·æ±‚åˆ°ESP32è°ƒèŠ‚PWMå ç©ºæ¯” -->
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3">
                    <label for="brightness-range" class="doc">äº®åº¦</label>
                </div>
                <div class="col-sm-12 col-md">
                    <!-- æ»‘å—inputï¼šèŒƒå›´0-100ï¼Œæ­¥é•¿1ï¼Œå®æ—¶è§¦å‘äº‹ä»¶ -->
                    <input type="range" id="brightness-range" min="0" max="100" value="100" step="1" style="width:70%;" class="doc">
                    <!-- å½“å‰äº®åº¦å€¼æ˜¾ç¤ºï¼Œå®æ—¶æ›´æ–° -->
                    <span id="brightness-value" style="display:inline-block; width:50px; text-align:right; font-weight:bold; color:#ff9800;">100%</span>
                </div>
            </div>
            
            <!-- ä½¿ç”¨æç¤º -->
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"></div>
                <div class="col-sm-12 col-md">
                    <small style="color:#666;">ğŸ’¡ è°ƒæ•´èŒƒå›´: 0 åˆ° 100ã€‚æ‹–åŠ¨æ»‘å—æ—¶ä¼šè‡ªåŠ¨åº”ç”¨ï¼Œå±å¹•ä¼šå®æ—¶åˆ·æ–°æ˜¾ç¤ºæ•ˆæœ</small>
                </div>
            </div>
        </fieldset>
        
        <!-- é‡ç½®æŒ‰é’® -->
        <!-- ä¸€é”®æ¢å¤åˆ°é»˜è®¤äº®åº¦ï¼ˆ100%ï¼‰ -->
        <div style="text-align: center; padding: 10px;">
            <button class="tertiary" onclick="resetBrightness()" type="button">é‡ç½®ä¸º100%</button>
        </div>
    </form>
    <!-- =================================================================== -->
    <!-- å±å¹•èƒŒå…‰äº®åº¦æ§åˆ¶è¡¨å•ç»“æŸ                                              -->
    <!-- =================================================================== -->
    <form id="wifi-form" autocomplete="off">
        <fieldset>
            <legend class="doc">ç½‘ç»œè®¾ç½®</legend>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label class="doc">æ‰«æWiFi:</label></div>
                <div class="col-sm-12 col-md">
                    <button class="tertiary" onclick="scanWifi()" type="button" style="margin-right: 10px;">æ‰«æé™„è¿‘WiFi</button>
                    <span id="scan-status" style="color: #666; font-size: 0.9em;"></span>
                </div>
            </div>
            <div class="row responsive-label" id="wifi-list-row" style="display: none;">
                <div class="col-sm-12 col-md-3"><label for="wifi-list-select" class="doc">é€‰æ‹©WiFi:</label></div>
                <div class="col-sm-12 col-md">
                    <select id="wifi-list-select" style="width:85%;" class="doc" onchange="onWifiSelected()">
                        <option value="">-- è¯·é€‰æ‹©WiFi --</option>
                    </select>
                </div>
            </div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="ssid1-text" class="doc">Wi-Fi åç§° (SSID):</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" required="required" maxlength="32" type="text" placeholder="ssid" id="ssid1-text" style="width:85%;" class="doc"></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="ssid1-pwd" class="doc">Wi-Fi å¯†ç </label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" required="required" maxlength="32" placeholder="password" id="ssid1-pwd" style="width:85%;" class="doc"></div></div>

            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="deviceip-text" class="doc">è®¾å¤‡IP:</label></div>
            <div class="col-sm-12 col-md"><input type="text" placeholder="wifi screen ip" id="deviceip-text" style="width:85%;" class="doc"></div></div>
            <!-- <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="gatewayip-text" class="doc">ç½‘å…³IP:</label></div>
            <div class="col-sm-12 col-md"><input type="text" placeholder="gateway ip" id="gatewayip-text" style="width:85%;" class="doc"></div></div> -->
        </fieldset>
        <div class="button-group">
            <button class="primary" type="submit">ä¿å­˜ç½‘ç»œè®¾ç½®</button>
            &nbsp;<button class="tertiary" onclick="reconnectWifi()" type="button">å®æ—¶é‡è¿WiFi</button>
        </div>
    </form>

    <form id="mqtt-form" autocomplete="off">
        <fieldset>
            <legend class="doc">MQTTè¿œç¨‹æœåŠ¡å™¨è®¾ç½®</legend>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-url-text" class="doc">MQTTæœåŠ¡å™¨:</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" maxlength="512" type="text" placeholder="ä¾‹:mqtt://broker.emqx.io:1883" id="mqtt-url-text" style="width:85%;" class="doc"></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-id-text" class="doc">MQTT Client Id:</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" rows="10" maxlength="512" type="text" placeholder="Client Id" id="mqtt-id-text" style="width:85%;" class="doc"></input></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-username-text" class="doc">MQTTç”¨æˆ·å:</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" rows="10" maxlength="512" type="text" placeholder="username" id="mqtt-username-text" style="width:85%;" class="doc"></input></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-password-text" class="doc">MQTTå¯†ç :</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" rows="10" maxlength="512" type="text" placeholder="password" id="mqtt-password-text" style="width:85%;" class="doc"></input></div></div>
            <div class="row responsive-label"><div class="col-sm-12 col-md-3"><label for="mqtt-topic-text" class="doc">è®¢é˜…ä¸»é¢˜(æ–‡æœ¬æ¶ˆæ¯):</label></div>
            <div class="col-sm-12 col-md"><input autocomplete="off" rows="10" maxlength="512" type="text" placeholder="Text Topic" id="mqtt-topic-text" style="width:85%;" class="doc"></input></div></div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label for="mqtt-qos" class="doc">Qos</label></div>
                <div class="col-sm-12 col-md">
                    <select id="mqtt-qos" style="width:85%;" class="doc">
                        <option class="doc">0</option>
                        <option class="doc">1</option>
                        <option class="doc">2</option>
                    </select>
                </div>
            </div>
        </fieldset>
        <div class="button-group">
            <button class="primary" type="submit">ä¿å­˜MQTTè®¾ç½®</button>
            <button class="tertiary" onclick="deleteMqttConfig()" type="button">åˆ é™¤MQTTè®¾ç½®</button>
            <button class="tertiary" onclick="reconnectMqtt()" type="button">å®æ—¶é‡è¿MQTT</button>
        </div>
    </form>

    <form id="speedtest-form" autocomplete="off">
        <fieldset>
            <legend class="doc">ä¼ è¾“é€Ÿåº¦æµ‹è¯•</legend>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label class="doc">æµ‹è¯•æ•°æ®å¤§å°:</label></div>
                <div class="col-sm-12 col-md">
                    <select id="test-data-size" style="width:85%;" class="doc">
                        <option value="10240">10 KB</option>
                        <option value="51200">50 KB</option>
                        <option value="102400" selected>100 KB</option>
                        <option value="204800">200 KB</option>
                        <option value="524288">512 KB</option>
                        <option value="1048576">1 MB</option>
                    </select>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label class="doc">HTTPé€Ÿåº¦:</label></div>
                <div class="col-sm-12 col-md">
                    <span id="http-speed-result" style="font-weight: bold; color: #1976d2;">--</span>
                    <button class="tertiary" onclick="runHttpSpeedTest()" type="button" style="margin-left: 10px;">æµ‹è¯•HTTP</button>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label class="doc">WebSocketé€Ÿåº¦:</label></div>
                <div class="col-sm-12 col-md">
                    <span id="ws-speed-result" style="font-weight: bold; color: #308732;">--</span>
                    <button class="tertiary" onclick="runWsSpeedTest()" type="button" style="margin-left: 10px;">æµ‹è¯•WebSocket</button>
                </div>
            </div>
            <div class="row responsive-label">
                <div class="col-sm-12 col-md-3"><label class="doc">æµ‹è¯•æ—¥å¿—:</label></div>
                <div class="col-sm-12 col-md">
                    <textarea id="speedtest-log" readonly style="width:85%; height:80px; font-size:12px; font-family:monospace;"></textarea>
                </div>
            </div>
        </fieldset>
    </form>

    <input type="checkbox" id="loading-control" class="modal">
    <div>
        <div class="card">
            <h4 class="section">æ­£åœ¨ä¿å­˜</h4>
            <p class="section">è¯·ç¨å€™...</p>
        </div>
    </div>

    <input type="checkbox" id="modal-control" class="modal">
    <div>
        <div class="card">
            <label for="modal-control" class="modal-close" ></label>
            <h4 class="section">æç¤º</h4>
            <p class="section" id="modal-text"></p>
        </div>
    </div>

    <script>
        function $(id){
            return document.getElementById(id);
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        var wifiConfigForm = $('wifi-form');
        var displayConfigForm = $('display-form');
        var wsserverConfigForm = $('wsserver-form');
        var mqttForm = $('mqtt-form');
        var colorAdjustForm = $('color-adjust-form');

        wifiConfigForm.addEventListener('submit', function(event) {
            event.preventDefault();
            submitWifiConfig();
        });

        mqttForm.addEventListener('submit', function(event){
            event.preventDefault();
            submitRemoteServerConfig();
        });

        displayConfigForm.addEventListener('submit', function(event) {
            event.preventDefault();
            submitDisplayConfig();
        });
        
        // è‰²è°ƒæ»‘å—å®æ—¶æ›´æ–°æ˜¾ç¤ºå€¼å’Œåº”ç”¨
        $('color-adjust-r').addEventListener('input', function() {
            updateColorAdjustValues();
            applyColorAdjustRealtime();
        });
        $('color-adjust-g').addEventListener('input', function() {
            updateColorAdjustValues();
            applyColorAdjustRealtime();
        });
        $('color-adjust-b').addEventListener('input', function() {
            updateColorAdjustValues();
            applyColorAdjustRealtime();
        });

        const checkLoading = $('loading-control');
        const dialog = $('modal-control');
        const dialogText = $('modal-text');

        function showTestDialog(){
            window.location.href = '/example';
        }

        async function generateJpegBlob(width, height, bgcolor, fgcolor, txt) {
            // è·å–Canvaså…ƒç´ 
            const canvas = document.getElementById('myCanvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // è®¾ç½®èƒŒæ™¯é¢œè‰²ä¸ºè“è‰²
            ctx.fillStyle = bgcolor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // è®¾ç½®å­—ä½“æ ·å¼
            ctx.font = '28px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // è®¾ç½®æ–‡å­—é¢œè‰²ä¸ºç™½è‰²
            ctx.fillStyle = fgcolor;

            // ç»˜åˆ¶æ–‡å­—
            ctx.fillText(txt, canvas.width / 2, canvas.height / 2);

            // åˆ›å»ºä¸€ä¸ªPromiseæ¥å¤„ç†å¼‚æ­¥çš„toBlobå›è°ƒå‡½æ•°
            return new Promise((resolve, reject) => {
                // å°†Canvaså†…å®¹å¯¼å‡ºä¸ºJPEGæ ¼å¼çš„Blobå¯¹è±¡
                canvas.toBlob(blob => {
                    if (blob) {
                        resolve(blob);
                    } else {
                        reject(new Error('Failed to convert canvas to blob.'));
                    }
                }, 'image/jpeg', 0.9); // ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è´¨é‡ï¼ˆ0åˆ°1ä¹‹é—´ï¼‰
            });
        }

        function showLoading(){
            checkLoading.checked = true;
        }
        function hideLoading(){
            checkLoading.checked = false;
        }
        
        // ç»Ÿä¸€çš„å…¨å±é®ç½©å‡½æ•°
        let overlayElement = null;
        function showOverlay(message) {
            if (!overlayElement) {
                overlayElement = document.createElement('div');
                overlayElement.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    font-size: 24px;
                    color: white;
                    font-weight: bold;
                `;
                document.body.appendChild(overlayElement);
            }
            overlayElement.textContent = message || 'æ­£åœ¨å¤„ç†...';
            overlayElement.style.display = 'flex';
        }
        
        function hideOverlay() {
            if (overlayElement) {
                overlayElement.style.display = 'none';
            }
        }

        function showDialog(msg){
            dialogText.innerHTML = msg;
            dialog.checked = true;
        }

        // WiFiæ‰«æç›¸å…³å‡½æ•°
        async function scanWifi() {
            const scanBtn = event.target;
            const scanStatus = $('scan-status');
            const wifiListRow = $('wifi-list-row');
            const wifiListSelect = $('wifi-list-select');
            
            scanBtn.disabled = true;
            scanStatus.textContent = 'æ­£åœ¨æ‰«æ...';
            scanStatus.style.color = '#0277bd';
            
            try {
                const response = await fetchWithTimeout('/scan_wifi', {
                    method: 'GET'
                }, 15000); // 15ç§’è¶…æ—¶
                
                const wifiList = JSON.parse(await response.text());
                
                if (wifiList && wifiList.length > 0) {
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    wifiListSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©WiFi --</option>';
                    
                    // æ·»åŠ æ‰«æåˆ°çš„WiFi
                    wifiList.forEach(wifi => {
                        const option = document.createElement('option');
                        option.value = wifi.ssid;
                        option.dataset.authMode = wifi.auth_mode;
                        // æ˜¾ç¤ºWiFiåç§°å’Œä¿¡å·å¼ºåº¦
                        option.textContent = `${wifi.ssid} (${wifi.signal_strength}%)`;
                        wifiListSelect.appendChild(option);
                    });
                    
                    wifiListRow.style.display = '';
                    scanStatus.textContent = `æ‰¾åˆ° ${wifiList.length} ä¸ªWiFiç½‘ç»œ`;
                    scanStatus.style.color = '#308732';
                } else {
                    scanStatus.textContent = 'æœªæ‰¾åˆ°WiFiç½‘ç»œ';
                    scanStatus.style.color = '#d32f2f';
                }
            } catch (e) {
                console.error('WiFiæ‰«æå¤±è´¥:', e);
                scanStatus.textContent = 'æ‰«æå¤±è´¥: ' + e.message;
                scanStatus.style.color = '#d32f2f';
            } finally {
                scanBtn.disabled = false;
            }
        }

        function onWifiSelected() {
            const wifiListSelect = $('wifi-list-select');
            const ssidInput = $('ssid1-text');
            const selectedOption = wifiListSelect.options[wifiListSelect.selectedIndex];
            
            if (selectedOption.value) {
                ssidInput.value = selectedOption.value;
                // å¦‚æœæ˜¯å¼€æ”¾ç½‘ç»œï¼Œæ¸…ç©ºå¯†ç 
                if (selectedOption.dataset.authMode === 'None') {
                    $('ssid1-pwd').value = '';
                }
            }
        }

        async function queryDisplayConfig() {
            var display_type = $('display-type');
            var screen_width = $('screen-width');
            var screen_height = $('screen-height');
            var x_offset = $('x-offset');
            var y_offset = $('y-offset');
            var check_cs = $('check-cs');
            var color_inversion = $('check-color_inversion');
            var mirrored = $('check-mirrored');
            var inclusive_end_coords = $('check-inclusive_end_coords');
            var spi_mode = $('spi-mode');
            var rotation = $('disp-rotation');
            var color_order = $('color-order');
            try{
                const response = await fetchWithTimeout('/display_config', {
                    method: 'GET'
                });
                let disp_config = JSON.parse(await response.text());
                if(disp_config != null){
                    if(disp_config.display_type != null && disp_config.display_type.trim().length>0){
                        display_type.value = disp_config.display_type;
                    }
                    if(disp_config.width != null && disp_config.width > 0){
                        screen_width.value = disp_config.width;
                    }
                    if(disp_config.height != null && disp_config.height > 0){
                        screen_height.value = disp_config.height;
                    }
                    x_offset.value = disp_config.x_offset || 0;
                    y_offset.value = disp_config.y_offset || 0;
                    check_cs.checked = disp_config.with_cs;
                    color_inversion.checked = disp_config.color_inversion;
                    rotation.selectedIndex = parseInt(parseInt(disp_config.rotation.replace('Deg', ''))/90);
                    mirrored.checked = disp_config.mirrored;
                    inclusive_end_coords.checked = disp_config.inclusive_end_coords;
                    spi_mode.selectedIndex = disp_config.spi_mode || 0;
                    if(disp_config.color_order != 'Rgb'){
                        color_order.selectedIndex = 1;
                    }else{
                        color_order.selectedIndex = 0;
                    }
                }
            }catch(e){
                console.log('wifiä¿¡æ¯è·å–å¤±è´¥:', e);
            }
            
            // è¯»å–è‰²è°ƒè°ƒæ•´é…ç½®
            try{
                const colorResponse = await fetch('/color_adjust');
                if(colorResponse.ok){
                    const colorData = await colorResponse.json();
                    $('color-adjust-r').value = colorData.r || 0;
                    $('color-adjust-g').value = colorData.g || 0;
                    $('color-adjust-b').value = colorData.b || 0;
                    updateColorAdjustValues();
                }
            }catch(e){
                console.log('è‰²è°ƒé…ç½®è·å–å¤±è´¥:', e);
            }
        }

        async function submitDisplayConfig(){
            var display_type = $('display-type');
            var screen_width = $('screen-width');
            var screen_height = $('screen-height');
            var x_offset = $('x-offset');
            var y_offset = $('y-offset');
            var check_cs = $('check-cs');
            var color_inversion = $('check-color_inversion');
            var mirrored = $('check-mirrored');
            var inclusive_end_coords = $('check-inclusive_end_coords');
            var spi_mode = $('spi-mode');
            var rotation = $('disp-rotation');
            var color_order = $('color-order');
            console.log('display_type:', display_type);
            console.log('spi_mode:', spi_mode);
            console.log('check_cs:', check_cs);

            showLoading();
            try{
                var colorOrderValue = 'Rgb';
                if(color_order.selectedIndex != 0){
                    colorOrderValue = 'Bgr'
                }
                const response = await fetch('/display_config', {
                    method: 'POST',
                    body: JSON.stringify({
                        display_type: display_type.value,
                        width: parseInt(screen_width.value),
                        height: parseInt(screen_height.value),
                        x_offset: parseInt(x_offset.value),
                        y_offset: parseInt(y_offset.value),
                        with_cs: check_cs.checked,
                        color_inversion: color_inversion.checked,
                        mirrored: mirrored.checked,
                        spi_mode: parseInt(spi_mode.selectedIndex),
                        rotation: 'Deg'+rotation.value.replace('åº¦', ''),
                        color_order: colorOrderValue,
                        inclusive_end_coords: inclusive_end_coords.checked,
                    })
                });
                let text = await response.text();
                if (text != 'OK') {    
                    showDialog('ä¿å­˜å¤±è´¥:'+text);
                }else{
                    showDialog('ä¿å­˜æˆåŠŸï¼Œç­‰å¾…é‡å¯...');
                }
            }catch(e){
                showDialog('ä¿å­˜å¤±è´¥:'+e);
            }
            hideLoading();
        }

        async function queryWifiConfig() {
            try{
                const response = await fetchWithTimeout('/wifi_config', {
                    method: 'GET'
                });
                let wifi_config = JSON.parse(await response.text());
                if(wifi_config != null){
                    var ssid1 = $('ssid1-text');
                    var pwd1 = $('ssid1-pwd');
                    var deviceip = $('deviceip-text');
                    // var gatewayip = $('gatewayip-text');
                    if(wifi_config.ssid != null && wifi_config.ssid.trim().length>0){
                        ssid1.value = wifi_config.ssid;
                    }
                    if(wifi_config.password != null && wifi_config.password.trim().length>0){
                        pwd1.value = wifi_config.password;
                    }
                    if(wifi_config.device_ip != null && wifi_config.device_ip.trim().length>0){
                        deviceip.value = wifi_config.device_ip;
                    }
                    // if(wifi_config.gateway_ip != null && wifi_config.gateway_ip.trim().length>0){
                    //     gatewayip.value = wifi_config.gateway_ip;
                    // }
                }
            }catch(e){
                console.log('wifiä¿¡æ¯è·å–å¤±è´¥:', e);
            }
        }

        async function submitWifiConfig(){
            var ssid1 = $('ssid1-text');
            var pwd1 = $('ssid1-pwd');
            var deviceip = $('deviceip-text');
            // var gatewayip = $('gatewayip-text');
            
            console.log('ssid1='+ssid1.value);
            console.log('pwd1='+pwd1.value);
            console.log('deviceip='+deviceip.value);
            // console.log('gatewayip='+gatewayip.value);

            showLoading();
            try{
                var cfg = {
                    ssid: ssid1.value,
                    password: pwd1.value
                };
                
                if(deviceip.value.trim().length>0){
                    cfg.device_ip = deviceip.value;
                }
                
                // ä¿å­˜é…ç½®
                const response = await fetchWithTimeout('/wifi_config', {
                    method: 'POST',
                    body: JSON.stringify(cfg)
                });

                let text = await response.text();
                if (text != 'OK') {    
                    showDialog('ä¿å­˜å¤±è´¥:'+text);
                }else{
                    showDialog('ä¿å­˜æˆåŠŸï¼Œç­‰å¾…é‡å¯...');
                }
            }catch(e){
                showDialog('ä¿å­˜å¤±è´¥:'+e);
            }
            hideLoading();
        }

        async function queryRemoteServerConfig() {
            try{
                const response = await fetchWithTimeout('/remote_server_config', {
                    method: 'GET'
                });
                let remote_server_config = JSON.parse(await response.text());
                console.log('queryRemoteServerConfig:', remote_server_config);
                if(remote_server_config != null){
                    var txtMqttUrl = $('mqtt-url-text');
                    var txtMqttClientId = $('mqtt-id-text');
                    var txtMqttUserName = $('mqtt-username-text');
                    var txtMqttPassword = $('mqtt-password-text');
                    var txtMqttTopic = $('mqtt-topic-text');
                    var selectMqttQos = $('mqtt-qos');
                    txtMqttUrl.value = remote_server_config.mqtt_url || '';
                    txtMqttClientId.value = remote_server_config.mqtt_client_id || '';
                    txtMqttUserName.value = remote_server_config.mqtt_username || '';
                    txtMqttPassword.value = remote_server_config.mqtt_password || '';
                    txtMqttTopic.value = remote_server_config.mqtt_topic || '';
                    if(remote_server_config.mqtt_qos == 'AtMostOnce'){
                        selectMqttQos.selectedIndex = 0;
                    }else if(remote_server_config.mqtt_qos == 'AtLeastOnce'){
                        selectMqttQos.selectedIndex = 1;
                    }else if(remote_server_config.mqtt_qos == 'ExactlyOnce'){
                        selectMqttQos.selectedIndex = 2;
                    }
                }
            }catch(e){
                console.log('è¿œç¨‹æœåŠ¡å™¨é…ç½®ä¿¡æ¯è·å–å¤±è´¥:', e);
            }
        }

        async function deleteMqttConfig() {
            const isConfirmed = window.confirm("ä½ ç¡®å®šè¦åˆ é™¤MQTTé…ç½®å—ï¼Ÿ");
            if(!isConfirmed){
                return;
            }
            showLoading();
            try{
                const response = await fetchWithTimeout('/delete_remote_server_config', {
                    method: 'GET'
                });

                let text = await response.text();
                if (text != 'OK') {    
                    showDialog('åˆ é™¤å¤±è´¥:'+text);
                }else{
                    showDialog('åˆ é™¤æˆåŠŸï¼Œç­‰å¾…é‡å¯...');
                }
            }catch(e){
                showDialog('åˆ é™¤å¤±è´¥:'+e);
            }
            hideLoading();
        }

        
        async function submitRemoteServerConfig(){
            var txtMqttUrl = $('mqtt-url-text');
            var txtMqttClientId = $('mqtt-id-text');
            var txtMqttUserName = $('mqtt-username-text');
            var txtMqttPassword = $('mqtt-password-text');
            var txtMqttTopic = $('mqtt-topic-text');
            var selectMqttQos = $('mqtt-qos');

            var mqtt_qos = 'AtMostOnce';
            console.log('selectMqttQos.selectedIndex==='+selectMqttQos.selectedIndex);
            if(selectMqttQos.selectedIndex == 1){
                mqtt_qos = 'AtLeastOnce';
            }else if(selectMqttQos.selectedIndex == 2) {
                mqtt_qos = 'ExactlyOnce';
            }

            showLoading();
            try{
                var cfg = {
                    mqtt_qos
                };
                if (txtMqttUrl.value.trim().length > 0){
                    cfg.mqtt_url = txtMqttUrl.value;
                }
                if(txtMqttClientId.value.trim().length>0){
                    cfg.mqtt_client_id = txtMqttClientId.value;
                }
                if(txtMqttUserName.value.trim().length>0){
                    cfg.mqtt_username = txtMqttUserName.value;
                }
                if(txtMqttPassword.value.trim().length>0){
                    cfg.mqtt_password = txtMqttPassword.value;
                }
                if(txtMqttTopic.value.trim().length>0){
                    cfg.mqtt_topic = txtMqttTopic.value;
                }
                
                const response = await fetchWithTimeout('/remote_server_config', {
                    method: 'POST',
                    body: JSON.stringify(cfg)
                });

                let text = await response.text();
                if (text != 'OK') {    
                    showDialog('ä¿å­˜å¤±è´¥:'+text);
                }else{
                    showDialog('ä¿å­˜æˆåŠŸï¼Œç­‰å¾…é‡å¯...');
                }
            }catch(e){
                showDialog('ä¿å­˜å¤±è´¥:'+e);
            }
            hideLoading();
        }

        function setScreen(index){
            $('preset-toggle').checked = false;

            var display_type = $('display-type');
            var screen_width = $('screen-width');
            var screen_height = $('screen-height');
            var x_offset = $('x-offset');
            var y_offset = $('y-offset');
            var check_cs = $('check-cs');
            var color_inversion = $('check-color_inversion');
            var inclusive_end_coords = $('check-inclusive_end_coords');
            var spi_mode = $('spi-mode');
            var rotation = $('disp-rotation');
            var mirrored = $('check-mirrored'); 
            var color_order = $('color-order');
            /*
            display_type:
            0 <=> ST7735s
            1 <=> ST7789
            2 <=> ST7796
            */
            if(index == 0){
                //ST7789-240x240ä¸å¸¦CS
                display_type.selectedIndex = 1;
                screen_width.value = 240;
                screen_height.value = 240;
                color_inversion.checked = true;
                check_cs.checked = false;
                x_offset.value = 0;
                y_offset.value = 0;
                spi_mode.selectedIndex = 3;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 0;
                inclusive_end_coords.checked = false;
            }
            if(index == 1){
                //ST7789-240x320å¸¦CS
                display_type.selectedIndex = 1;
                screen_width.value = 240;
                screen_height.value = 320;
                color_inversion.checked = false;
                check_cs.checked = true;
                x_offset.value = 0;
                y_offset.value = 0;
                spi_mode.selectedIndex = 3;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 0;
                inclusive_end_coords.checked = false;
            }
            if(index == 2){
                //ST7789V-135x240å¸¦CS
                display_type.selectedIndex = 1;
                screen_width.value = 135;
                screen_height.value = 240;
                color_inversion.checked = true;
                check_cs.checked = true;
                x_offset.value = 52;
                y_offset.value = 40;
                spi_mode.selectedIndex = 0;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 0;
                inclusive_end_coords.checked = true;
            }
            if(index == 3){
                //ST7735S-128x160å¸¦CS
                display_type.selectedIndex = 0;
                screen_width.value = 128;
                screen_height.value = 160;
                color_inversion.checked = false;
                check_cs.checked = true;
                x_offset.value = 0;
                y_offset.value = 0;
                spi_mode.selectedIndex = 0;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 0;
                inclusive_end_coords.checked = false;
            }
            if(index == 4){
                //ST7735S-80x160å¸¦CS
                display_type.selectedIndex = 0;
                screen_width.value = 80;
                screen_height.value = 160;
                color_inversion.checked = true;
                check_cs.checked = true;
                x_offset.value = 26;
                y_offset.value = 0;
                spi_mode.selectedIndex = 0;
                mirrored.checked = false;
                rotation.selectedIndex = 0;
                color_order.selectedIndex = 1;
                inclusive_end_coords.checked = true;
            }
            if(index == 6){
                //ST7796-320x480å¸¦CS
                display_type.selectedIndex = 2;
                screen_width.value = 320;
                screen_height.value = 480;
                color_inversion.checked = false;
                check_cs.checked = true;
                x_offset.value = 0;
                y_offset.value = 0;
                spi_mode.selectedIndex = 3;
                rotation.selectedIndex = 0;
                mirrored.checked = true;
                color_order.selectedIndex = 1;
                inclusive_end_coords.checked = false;
            }
        }

        async function fetchWithTimeout(url, options = {}, timeout = 5000) {
            // åˆ›å»ºä¸€ä¸ªAbortControllerå®ä¾‹
            const controller = new AbortController();
            const { signal } = controller;

            // è®¾ç½®è¶…æ—¶
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, timeout);

            try {
                // å‘èµ·fetchè¯·æ±‚ï¼Œå¹¶ä¼ é€’signalä»¥å…è®¸å–æ¶ˆè¯·æ±‚
                const response = await Promise.race([
                    fetch(url, { ...options, signal }),
                    new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Request timed out')), timeout)
                    )
                ]);

                // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                clearTimeout(timeoutId);

                return response;
            } catch (error) {
                // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                clearTimeout(timeoutId);

                if (error.name === 'AbortError') {
                    throw new Error('Request aborted due to timeout');
                }

                throw error; // æŠ›å‡ºå…¶ä»–é”™è¯¯
            }
        }

        // ========== Speed Test Functions ==========
        function logSpeedTest(msg) {
            const log = $('speedtest-log');
            const now = new Date().toLocaleTimeString();
            log.value += `[${now}] ${msg}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function formatSpeed(bytesPerSecond) {
            if (bytesPerSecond >= 1024 * 1024) {
                return (bytesPerSecond / (1024 * 1024)).toFixed(2) + ' MB/s';
            } else if (bytesPerSecond >= 1024) {
                return (bytesPerSecond / 1024).toFixed(2) + ' KB/s';
            }
            return bytesPerSecond.toFixed(0) + ' B/s';
        }

        async function runHttpSpeedTest() {
            const resultSpan = $('http-speed-result');
            const dataSize = parseInt($('test-data-size').value);
            
            resultSpan.textContent = 'Testing...';
            resultSpan.style.color = '#666';
            logSpeedTest(`HTTP Echo test, size: ${(dataSize/1024).toFixed(0)} KB`);
            
            try {
                // Generate test data
                const testData = new Uint8Array(dataSize);
                for (let i = 0; i < dataSize; i++) {
                    testData[i] = i % 256;
                }
                
                const startTime = performance.now();
                
                // Server will echo back the same data
                const response = await fetch('/speed_test_echo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/octet-stream' },
                    body: testData
                });
                
                // Read the echoed response
                const responseData = await response.arrayBuffer();
                const endTime = performance.now();
                
                const roundTripMs = endTime - startTime;
                // Total bytes = upload + download
                const totalBytes = dataSize + responseData.byteLength;
                const bytesPerSecond = (totalBytes / roundTripMs) * 1000;
                // Single direction speed (divide by 2 for upload or download)
                const singleDirSpeed = bytesPerSecond / 2;
                
                resultSpan.textContent = `${formatSpeed(singleDirSpeed)} (RTT: ${roundTripMs.toFixed(0)}ms)`;
                resultSpan.style.color = '#1976d2';
                logSpeedTest(`HTTP: ${formatSpeed(singleDirSpeed)}, RTT: ${roundTripMs.toFixed(0)}ms, total: ${(totalBytes/1024).toFixed(0)}KB`);
            } catch (e) {
                resultSpan.textContent = 'Error: ' + e.message;
                resultSpan.style.color = '#d32f2f';
                logSpeedTest(`HTTP error: ${e.message}`);
            }
        }

        // Global WebSocket connection for speed test (reuse connection)
        let speedTestSocket = null;
        
        async function getSpeedTestSocket() {
            if (speedTestSocket && speedTestSocket.readyState === WebSocket.OPEN) {
                return speedTestSocket;
            }
            
            // Close existing socket if any
            if (speedTestSocket) {
                try { speedTestSocket.close(); } catch(e) {}
                speedTestSocket = null;
            }
            
            const wsUrl = 'ws://' + window.location.host + '/ws';
            speedTestSocket = new WebSocket(wsUrl);
            speedTestSocket.binaryType = 'arraybuffer';
            
            await new Promise((resolve, reject) => {
                speedTestSocket.onopen = () => {
                    // Skip welcome message
                    speedTestSocket.onmessage = () => resolve();
                };
                speedTestSocket.onerror = () => reject(new Error('WebSocket connection failed'));
                setTimeout(() => reject(new Error('WebSocket connection timeout')), 5000);
            });
            
            return speedTestSocket;
        }
        
        async function runWsSpeedTest() {
            const resultSpan = $('ws-speed-result');
            const dataSize = parseInt($('test-data-size').value);
            
            // Limit WebSocket test to 200KB to avoid memory issues on ESP32
            const MAX_WS_TEST_SIZE = 200 * 1024;
            const actualSize = Math.min(dataSize, MAX_WS_TEST_SIZE);
            
            if (dataSize > MAX_WS_TEST_SIZE) {
                logSpeedTest(`WebSocket test limited to ${MAX_WS_TEST_SIZE/1024}KB (ESP32 memory limit)`);
            }
            
            resultSpan.textContent = 'Testing...';
            resultSpan.style.color = '#666';
            logSpeedTest(`WebSocket Echo test, size: ${(actualSize/1024).toFixed(0)} KB`);
            
            try {
                const socket = await getSpeedTestSocket();
                
                // Generate test data
                const header = new TextEncoder().encode('ECHO_TEST:');
                const testData = new Uint8Array(actualSize);
                for (let i = 0; i < actualSize; i++) {
                    testData[i] = i % 256;
                }
                const fullData = new Uint8Array(header.length + testData.length);
                fullData.set(header);
                fullData.set(testData, header.length);
                
                const startTime = performance.now();
                
                // Setup response handler
                const responsePromise = new Promise((resolve, reject) => {
                    socket.onmessage = (event) => {
                        if (event.data instanceof ArrayBuffer) {
                            resolve(event.data.byteLength);
                        } else if (typeof event.data === 'string') {
                            // Text response (error message)
                            reject(new Error(event.data));
                        }
                    };
                    socket.onerror = () => reject(new Error('WebSocket error'));
                    setTimeout(() => reject(new Error('WebSocket response timeout')), 15000);
                });
                
                // Send data as single message
                socket.send(fullData);
                
                const receivedBytes = await responsePromise;
                const endTime = performance.now();
                
                const roundTripMs = endTime - startTime;
                // Total bytes = upload + download
                const totalBytes = actualSize + receivedBytes;
                const bytesPerSecond = (totalBytes / roundTripMs) * 1000;
                const singleDirSpeed = bytesPerSecond / 2;
                
                resultSpan.textContent = `${formatSpeed(singleDirSpeed)} (RTT: ${roundTripMs.toFixed(0)}ms)`;
                resultSpan.style.color = '#308732';
                logSpeedTest(`WebSocket: ${formatSpeed(singleDirSpeed)}, RTT: ${roundTripMs.toFixed(0)}ms, total: ${(totalBytes/1024).toFixed(0)}KB`);
            } catch (e) {
                resultSpan.textContent = 'Error: ' + e.message;
                resultSpan.style.color = '#d32f2f';
                logSpeedTest(`WebSocket error: ${e.message}`);
                // Close broken socket
                if (speedTestSocket) {
                    try { speedTestSocket.close(); } catch(ex) {}
                    speedTestSocket = null;
                }
            }
        }

        // æ›´æ–°è‰²è°ƒè°ƒæ•´æ˜¾ç¤ºå€¼
        function updateColorAdjustValues() {
            const r = $('color-adjust-r').value;
            const g = $('color-adjust-g').value;
            const b = $('color-adjust-b').value;
            $('color-adjust-r-value').textContent = (r > 0 ? '+' : '') + r;
            $('color-adjust-g-value').textContent = (g > 0 ? '+' : '') + g;
            $('color-adjust-b-value').textContent = (b > 0 ? '+' : '') + b;
        }
        
        // å®æ—¶åº”ç”¨è‰²è°ƒè°ƒæ•´ï¼ˆç±»ä¼¼å±å¹•æ—‹è½¬çš„å®æ—¶ç”Ÿæ•ˆï¼‰
        let colorAdjustTimeout = null;
        let isApplyingColorAdjust = false;
        async function applyColorAdjustRealtime() {
            const r = parseInt($('color-adjust-r').value);
            const g = parseInt($('color-adjust-g').value);
            const b = parseInt($('color-adjust-b').value);
            
            // é˜²æŠ–ï¼šç”¨æˆ·åœæ­¢æ‹–åŠ¨æ»‘å—300msåæ‰å‘é€è¯·æ±‚
            if (colorAdjustTimeout) {
                clearTimeout(colorAdjustTimeout);
            }
            
            colorAdjustTimeout = setTimeout(async () => {
                // é˜²æ­¢å¹¶å‘è¯·æ±‚
                if (isApplyingColorAdjust) {
                    return;
                }
                
                isApplyingColorAdjust = true;
                const adjustText = 'R:' + (r > 0 ? '+' : '') + r + ' G:' + (g > 0 ? '+' : '') + g + ' B:' + (b > 0 ? '+' : '') + b;
                showOverlay('æ­£åœ¨åº”ç”¨è‰²è°ƒ: ' + adjustText);
                
                try{
                    const response = await fetch('/color_adjust', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ r, g, b })
                    });
                    
                    const text = await response.text();
                    if (text === 'OK') {
                        console.log('è‰²è°ƒå·²å®æ—¶åº”ç”¨: R=' + r + ', G=' + g + ', B=' + b);
                        // æˆåŠŸåç­‰å¾…500msè®©ç”¨æˆ·çœ‹åˆ°å±å¹•ä¸Šçš„æ•ˆæœ
                        setTimeout(() => {
                            hideOverlay();
                            isApplyingColorAdjust = false;
                        }, 500);
                    } else {
                        hideOverlay();
                        isApplyingColorAdjust = false;
                        showDialog('è‰²è°ƒè°ƒæ•´å¤±è´¥: ' + text);
                    }
                } catch(e) {
                    hideOverlay();
                    isApplyingColorAdjust = false;
                    showDialog('è‰²è°ƒè°ƒæ•´å¤±è´¥: ' + e);
                }
            }, 300);
        }
        
        // åº”ç”¨è‰²è°ƒé¢„è®¾
        function applyColorPreset(preset) {
            let r = 0, g = 0, b = 0;
            
            switch(preset) {
                case 'fix-blue':
                    // ä¿®å¤åè“ï¼šé™ä½è“è‰²é€šé“
                    r = 0;
                    g = 0;
                    b = -30;
                    break;
                case 'fix-yellow':
                    // ä¿®å¤åé»„ï¼šé™ä½çº¢è‰²å’Œç»¿è‰²
                    r = -15;
                    g = -15;
                    b = 0;
                    break;
                case 'warm':
                    // æš–è‰²è°ƒï¼šå¢å¼ºçº¢è‰²ï¼Œé™ä½è“è‰²
                    r = 20;
                    g = 10;
                    b = -15;
                    break;
                case 'cool':
                    // å†·è‰²è°ƒï¼šé™ä½çº¢è‰²ï¼Œå¢å¼ºè“è‰²
                    r = -15;
                    g = 0;
                    b = 20;
                    break;
            }
            
            $('color-adjust-r').value = r;
            $('color-adjust-g').value = g;
            $('color-adjust-b').value = b;
            updateColorAdjustValues();
            applyColorAdjustRealtime();
        }
        
        // é‡ç½®è‰²è°ƒè°ƒæ•´
        function resetColorAdjust() {
            $('color-adjust-r').value = 0;
            $('color-adjust-g').value = 0;
            $('color-adjust-b').value = 0;
            updateColorAdjustValues();
            // ç«‹å³åº”ç”¨é‡ç½®åçš„å€¼åˆ°å±å¹•
            applyColorAdjustRealtime();
        }
        
        // ===================================================================
        // å±å¹•èƒŒå…‰äº®åº¦æ§åˆ¶JavaScriptå‡½æ•°                                        
        // ===================================================================
        // å®ç°è¦ç‚¹cï¼šhttp_server.rså’Œindex.htmlä¸­ä¿®æ”¹åäº®åº¦å¹¶å®æ—¶åˆ·æ–°äº®åº¦      
        //                                                                      
        // åŠŸèƒ½è¯´æ˜ï¼š                                                            
        // - æä¾›æ»‘å—å’ŒæŒ‰é’®ä¸¤ç§æ–¹å¼è°ƒèŠ‚äº®åº¦                                     
        // - æ”¯æŒ0-100%èŒƒå›´è°ƒèŠ‚                                                 
        // - æ‹–åŠ¨æ»‘å—å®æ—¶ç”Ÿæ•ˆï¼ˆé˜²æŠ–250msï¼‰                                      
        // - æä¾›4ä¸ªå¿«æ·é¢„è®¾æŒ‰é’®ï¼ˆ25%, 50%, 75%, 100%ï¼‰                        
        // - å½“å‰äº®åº¦å€¼å®æ—¶æ˜¾ç¤º                                                 
        // - é‡ç½®æŒ‰é’®å¯å¿«é€Ÿæ¢å¤åˆ°100%                                           
        // - é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥è¯¢å½“å‰äº®åº¦å€¼                                       
        //                                                                      
        // æŠ€æœ¯å®ç°ï¼š                                                            
        // - æ»‘å—inputäº‹ä»¶è§¦å‘applyBrightnessRealtime()                        
        // - é˜²æŠ–å¤„ç†é˜²æ­¢é¢‘ç¹è¯·æ±‚ï¼ˆ250mså»¶è¿Ÿï¼‰                                 
        // - å‘é€POST /brightnessè¯·æ±‚åˆ°ESP32                                  
        // - ESP32é€šè¿‡GPIO13 PWMå®æ—¶è°ƒèŠ‚å±å¹•äº®åº¦                               
        // - åŒæ—¶åœ¨å±å¹•ä¸Šæ˜¾ç¤º"Brightness: XX%"æç¤º                             
        // - äº®åº¦å€¼è‡ªåŠ¨ä¿å­˜åˆ°NVSï¼Œé‡å¯åæ¢å¤                                   
        // ===================================================================
        
        // æ›´æ–°äº®åº¦æ˜¾ç¤ºå€¼ï¼ˆåœ¨UIä¸Šæ˜¾ç¤ºå½“å‰äº®åº¦ç™¾åˆ†æ¯”ï¼‰
        // å½“æ»‘å—å€¼æ”¹å˜æ—¶ï¼ŒåŒæ­¥æ›´æ–°æ—è¾¹çš„æ–‡æœ¬æ˜¾ç¤º
        function updateBrightnessDisplay() {
            const v = $('brightness-range').value;  // è·å–æ»‘å—å½“å‰å€¼ï¼ˆ0-100ï¼‰
            $('brightness-value').textContent = v + '%';  // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
        }

        // é˜²æŠ–å®šæ—¶å™¨å’ŒçŠ¶æ€æ ‡å¿—
        let brightnessTimeout = null;  // ç”¨äºé˜²æŠ–çš„å®šæ—¶å™¨ID
        let isApplyingBrightness = false;  // é˜²æ­¢å¹¶å‘è¯·æ±‚çš„æ ‡å¿—
        
        // å®æ—¶åº”ç”¨äº®åº¦è°ƒæ•´ï¼ˆé˜²æŠ–å¤„ç†ï¼‰
        // å½“ç”¨æˆ·æ‹–åŠ¨æ»‘å—æ—¶ï¼Œå»¶è¿Ÿ250msåå‘é€è¯·æ±‚åˆ°ESP32
        // é¿å…é¢‘ç¹æ‹–åŠ¨å¯¼è‡´è¿‡å¤šHTTPè¯·æ±‚
        async function applyBrightnessRealtime() {
            const value = parseInt($('brightness-range').value);  // è·å–æ»‘å—å€¼ï¼ˆ0-100ï¼‰

            // é˜²æŠ–å¤„ç†ï¼šæ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (brightnessTimeout) clearTimeout(brightnessTimeout);
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ250msåæ‰§è¡Œ
            brightnessTimeout = setTimeout(async () => {
                // é˜²æ­¢å¹¶å‘ï¼šå¦‚æœæ­£åœ¨å¤„ç†å¦ä¸€ä¸ªè¯·æ±‚ï¼Œç›´æ¥è¿”å›
                if (isApplyingBrightness) return;
                
                isApplyingBrightness = true;  // è®¾ç½®æ ‡å¿—
                const message = value + '%';  // æç¤ºä¿¡æ¯
                showOverlay('æ­£åœ¨åº”ç”¨äº®åº¦: ' + message);  // æ˜¾ç¤ºå…¨å±é®ç½©
                
                try{
                    // å‘é€POSTè¯·æ±‚åˆ°ESP32çš„/brightnessæ¥å£
                    // è¯·æ±‚ä½“ä¸ºJSONæ ¼å¼ï¼š{"brightness": value}
                    const response = await fetch('/brightness', {
                        method: 'POST',
                        body: JSON.stringify({ brightness: value }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const text = await response.text();
                    if (text != 'OK') {
                        // è¯·æ±‚å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
                        showDialog('äº®åº¦æ›´æ–°å¤±è´¥: ' + text);
                    }
                }catch(e){
                    // ç½‘ç»œé”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
                    showDialog('äº®åº¦æ›´æ–°å¤±è´¥: ' + e);
                }
                
                hideOverlay();  // éšè—å…¨å±é®ç½©
                isApplyingBrightness = false;  // é‡ç½®æ ‡å¿—
            }, 250);  // 250msé˜²æŠ–å»¶è¿Ÿ
        }

        // åº”ç”¨äº®åº¦é¢„è®¾å€¼
        // ç‚¹å‡»å¿«æ·æŒ‰é’®æ—¶è°ƒç”¨ï¼Œç›´æ¥è®¾ç½®æ»‘å—å€¼å¹¶è§¦å‘å®æ—¶åº”ç”¨
        // @param v - é¢„è®¾äº®åº¦å€¼ï¼ˆ25, 50, 75, 100ï¼‰
        function applyBrightnessPreset(v){
            $('brightness-range').value = v;  // è®¾ç½®æ»‘å—å€¼
            updateBrightnessDisplay();  // æ›´æ–°æ˜¾ç¤º
            applyBrightnessRealtime();  // è§¦å‘å®æ—¶åº”ç”¨
        }

        // é‡ç½®äº®åº¦åˆ°é»˜è®¤å€¼ï¼ˆ100%ï¼‰
        // ä¸€é”®æ¢å¤åˆ°æœ€äº®çŠ¶æ€
        function resetBrightness(){
            $('brightness-range').value = 100;  // è®¾ç½®æ»‘å—ä¸º100
            updateBrightnessDisplay();  // æ›´æ–°æ˜¾ç¤º
            applyBrightnessRealtime();  // è§¦å‘å®æ—¶åº”ç”¨
        }

        // åˆå§‹åŒ–äº®åº¦å€¼ï¼ˆé¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰
        // ä»ESP32è·å–å½“å‰äº®åº¦å€¼ï¼Œå¹¶è®¾ç½®æ»‘å—ä½ç½®
        async function queryBrightness(){
            try{
                // å‘é€GETè¯·æ±‚åˆ°/brightnessæ¥å£
                const resp = await fetch('/brightness');
                if(resp.ok){
                    const data = await resp.json();  // è§£æJSONå“åº”
                    if(typeof data.brightness !== 'undefined'){
                        const b = parseInt(data.brightness);  // è·å–äº®åº¦å€¼
                        $('brightness-range').value = b;  // è®¾ç½®æ»‘å—
                        updateBrightnessDisplay();  // æ›´æ–°æ˜¾ç¤º
                    }
                }
            }catch(e){
                console.log('äº®åº¦è·å–å¤±è´¥:', e);  // è®°å½•é”™è¯¯åˆ°æ§åˆ¶å°
            }
        }

        // ç»‘å®šæ»‘å—inputäº‹ä»¶
        // å½“ç”¨æˆ·æ‹–åŠ¨æ»‘å—æ—¶ï¼Œå®æ—¶æ›´æ–°æ˜¾ç¤ºå¹¶è§¦å‘é˜²æŠ–å¤„ç†
        $('brightness-range').addEventListener('input', function(){ 
            updateBrightnessDisplay();  // æ›´æ–°æ˜¾ç¤ºå€¼
            applyBrightnessRealtime();  // è§¦å‘å®æ—¶åº”ç”¨ï¼ˆå¸¦é˜²æŠ–ï¼‰
        });
        // ===================================================================
        // å±å¹•èƒŒå…‰äº®åº¦æ§åˆ¶JavaScriptå‡½æ•°ç»“æŸ                                      
        // ===================================================================
        
        // å®æ—¶åº”ç”¨å±å¹•æ—‹è½¬ï¼ˆæ— éœ€é‡å¯ï¼‰
        async function applyRotationRealtime() {
            const rotation = $('disp-rotation');
            const rotationValue = 'Deg' + rotation.value.replace('åº¦', '');
            
            showOverlay('æ­£åœ¨åº”ç”¨æ—‹è½¬: ' + rotation.value);
            try {
                const response = await fetch('/display_rotation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rotation: rotationValue })
                });
                
                const text = await response.text();
                if (text != 'OK') {
                    hideOverlay();
                    showDialog('æ—‹è½¬æ–¹å‘æ›´æ–°å¤±è´¥: ' + text);
                } else {
                    // æˆåŠŸåç­‰å¾…500msè®©ç”¨æˆ·çœ‹åˆ°å±å¹•ä¸Šçš„ç¡®è®¤ä¿¡æ¯
                    setTimeout(() => {
                        hideOverlay();
                    }, 500);
                }
            } catch(e) {
                hideOverlay();
                showDialog('æ—‹è½¬æ–¹å‘æ›´æ–°å¤±è´¥: ' + e);
            }
        }
        
        // å®æ—¶é‡è¿WiFiï¼ˆéƒ¨åˆ†ç”Ÿæ•ˆï¼Œå®Œæ•´é‡è¿å¯èƒ½éœ€è¦é‡å¯ï¼‰
        async function reconnectWifi() {
            const ssid = $('ssid1-text').value;
            const password = $('ssid1-pwd').value;
            const deviceIp = $('deviceip-text').value;
            
            if (!ssid || ssid.trim() === '') {
                showDialog('è¯·å¡«å†™WiFiåç§°(SSID)');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦é‡æ–°è¿æ¥WiFiå—ï¼Ÿ\n\næ³¨æ„ï¼šå¦‚æœæ–°WiFiè¿æ¥å¤±è´¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´è®¾å¤‡æ— æ³•è®¿é—®ã€‚\nå®Œæ•´çš„WiFié‡è¿å¯èƒ½éœ€è¦é‡å¯è®¾å¤‡æ‰èƒ½ç”Ÿæ•ˆã€‚')) {
                return;
            }
            
            showLoading();
            try {
                const response = await fetch('/wifi_reconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ssid: ssid, 
                        password: password,
                        device_ip: deviceIp
                    })
                });
                
                const text = await response.text();
                if (text != 'OK') {
                    showDialog('WiFié‡è¿å¤±è´¥: ' + text);
                } else {
                    showDialog('WiFié…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨åå°é‡è¿...\n\nå¦‚æœè®¾å¤‡æ— æ³•è¿æ¥æ–°WiFiï¼Œè¯·é‡å¯è®¾å¤‡ã€‚');
                }
            } catch(e) {
                showDialog('WiFié‡è¿å¤±è´¥: ' + e);
            }
            hideLoading();
        }
        
        // å®æ—¶é‡è¿MQTTï¼ˆæ— éœ€é‡å¯ï¼‰
        async function reconnectMqtt() {
            const url = $('mqtt-url-text').value;
            const clientId = $('mqtt-id-text').value;
            const username = $('mqtt-username-text').value;
            const password = $('mqtt-password-text').value;
            const topic = $('mqtt-topic-text').value;
            const qos = parseInt($('mqtt-qos').value);
            
            if (!url || url.trim() === '') {
                showDialog('è¯·å¡«å†™MQTTæœåŠ¡å™¨åœ°å€');
                return;
            }
            
            showLoading();
            try {
                const response = await fetch('/mqtt_reconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        client_id: clientId,
                        username: username,
                        password: password,
                        topic: topic,
                        qos: qos
                    })
                });
                
                const text = await response.text();
                if (text != 'OK') {
                    showDialog('MQTTé‡è¿å¤±è´¥: ' + text);
                } else {
                    showDialog('MQTTé…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨åå°é‡è¿...');
                }
            } catch(e) {
                showDialog('MQTTé‡è¿å¤±è´¥: ' + e);
            }
            hideLoading();
        }

        // ===================================================================
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å„é¡¹é…ç½®æŸ¥è¯¢                                  
        // ===================================================================
        // ä¾æ¬¡æŸ¥è¯¢WiFié…ç½®ã€æ˜¾ç¤ºé…ç½®ã€è¿œç¨‹æœåŠ¡å™¨é…ç½®å’Œäº®åº¦é…ç½®
        // ç¡®ä¿é¡µé¢æ˜¾ç¤ºæ—¶å„é¡¹é…ç½®éƒ½æ˜¯æœ€æ–°çš„
        queryWifiConfig();  // æŸ¥è¯¢WiFié…ç½®ï¼ˆSSIDã€å¯†ç ç­‰ï¼‰
        queryDisplayConfig();  // æŸ¥è¯¢æ˜¾ç¤ºé…ç½®ï¼ˆåˆ†è¾¨ç‡ã€é©±åŠ¨ç±»å‹ç­‰ï¼‰
        queryRemoteServerConfig();  // æŸ¥è¯¢MQTTæœåŠ¡å™¨é…ç½®
        queryBrightness();  // æŸ¥è¯¢å½“å‰äº®åº¦å€¼ï¼ˆä»NVSè¯»å–ï¼‰å¹¶è®¾ç½®æ»‘å—ä½ç½®
    </script>
</body>
</html>
<!-- =================================================================== -->
<!-- HTMLæ–‡æ¡£ç»“æŸ                                                         -->
<!-- =================================================================== -->
<!--                                                                      -->
<!-- å±å¹•èƒŒå…‰äº®åº¦æ§åˆ¶åŠŸèƒ½æ€»ç»“ï¼š                                            -->
<!-- - GPIO13ä½œä¸ºPWMè¾“å‡ºæ§åˆ¶å±å¹•èƒŒå…‰                                      -->
<!-- - äº®åº¦èŒƒå›´ï¼š0-100%ï¼ˆ0=å…³é—­ï¼Œ100=æœ€äº®ï¼‰                              -->
<!-- - é¢‘ç‡ï¼š25kHzï¼ˆæ— é—ªçƒï¼‰                                             -->
<!-- - åˆ†è¾¨ç‡ï¼š10ä½ï¼ˆ0-1023ï¼Œå…±1024çº§ï¼‰                                  -->
<!-- - é…ç½®æŒä¹…åŒ–ï¼šäº®åº¦å€¼ä¿å­˜åˆ°NVSï¼Œé‡å¯åè‡ªåŠ¨æ¢å¤                       -->
<!-- - Webç•Œé¢ï¼šæ»‘å—+æŒ‰é’®æ§åˆ¶ï¼Œå®æ—¶ç”Ÿæ•ˆ                                  -->
<!-- - HTTP APIï¼šPOST /brightness è®¾ç½®äº®åº¦                               -->
<!-- - HTTP APIï¼šGET /brightness è·å–å½“å‰äº®åº¦                            -->
<!--                                                                      -->
<!-- å®ç°è¦ç‚¹éªŒè¯ï¼š                                                        -->
<!-- âœ… a) PWM GPIO13å±å¹•èƒŒå…‰æ§åˆ¶é€»è¾‘æ ¸å‡½æ•°ï¼ˆdisplay.rsï¼‰                -->
<!-- âœ… b) NVSé…ç½®ä¸­äº®åº¦å€¼ä¿å­˜é€»è¾‘ï¼ˆconfig.rs + http_server.rsï¼‰         -->
<!-- âœ… c) HTTPå’ŒHTMLå®æ—¶æ§åˆ¶ï¼ˆhttp_server.rs + index.htmlï¼‰             -->
<!-- âœ… d) å¯åŠ¨æ—¶ä»é…ç½®è¯»å–äº®åº¦ï¼ˆmain.rs + display.rsï¼‰                  -->
<!--                                                                      -->
<!-- =================================================================== -->